<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TronLink Nileæµ‹è¯•ç½‘è½¬è´¦TRX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        button{padding: 10px 20px;font-size: 16px;margin: 10px 0;cursor: pointer;background: #2196F3;color: #fff;border: none;border-radius: 6px;}
        button:disabled{background: #ccc;cursor: not-allowed;}
        #msg{margin-top: 20px;padding: 10px;border-radius: 6px;font-size: 14px;}
        .success{color: #198754;background: #d1e7dd;}
        .error{color: #dc3545;background: #f8d7da;}
        .info{color: #0d6efd;background: #cfe2ff;}
    </style>
</head>
<body>
    <h3>æ³¢åœºNileæµ‹è¯•ç½‘ | è½¬è´¦10 TRXåˆ°æŒ‡å®šåœ°å€</h3>
    <p>æ”¶æ¬¾åœ°å€ï¼š<strong>TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3</strong></p>
    <button id="connectBtn" onclick="connectTronLink()">è¿æ¥TronLinké’±åŒ…</button>
    <button id="transferBtn" onclick="transferTRX()" disabled>è½¬è´¦10 TRXï¼ˆæµ‹è¯•å¸ï¼‰</button>
    <div id="msg" class="info">è¯·å…ˆè¿æ¥TronLinké’±åŒ…ï¼Œç¡®ä¿åˆ‡æ¢è‡³ Nile æµ‹è¯•ç½‘</div>

    <script>
        // ===================== æ ¸å¿ƒé…ç½®é¡¹ =====================
        // ç›®æ ‡æ”¶æ¬¾åœ°å€ï¼ˆå›ºå®šï¼‰
        const TO_ADDRESS = 'TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3';
        // è½¬è´¦æ•°é‡ 10 TRX
        const TRX_AMOUNT = 10;
        // Nileæµ‹è¯•ç½‘ å®˜æ–¹èŠ‚ç‚¹ï¼ˆå¿…é¡»ç”¨æµ‹è¯•ç½‘èŠ‚ç‚¹ï¼‰
        const NILE_NODE_URL = 'https://nile.trongrid.io';
        // TRXç²¾åº¦ï¼š1TRX = 10^6 SUNï¼Œè½¬è´¦å¿…é¡»ç”¨SUNä¸ºå•ä½
        const SUN_RATIO = 1000000;

        // å…¨å±€TronWebå®ä¾‹
        let tronWeb = null;
        // é’±åŒ…åœ°å€
        let userAddress = '';

        // ===================== 1. æ£€æµ‹+è¿æ¥TronLinké’±åŒ… =====================
        async function connectTronLink() {
            const msgDom = document.getElementById('msg');
            try {
                // æ£€æµ‹TronLinkæ˜¯å¦å®‰è£…
                if (!window.tronWeb) {
                    msgDom.className = 'error';
                    msgDom.innerText = 'âŒ æœªæ£€æµ‹åˆ°TronLinké’±åŒ…ï¼Œè¯·å…ˆå®‰è£…TronLinkæ’ä»¶/APPï¼';
                    return false;
                }

                // å”¤èµ·TronLinkæˆæƒè¿æ¥é’±åŒ…
                const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                if (!res || res.length === 0) {
                    msgDom.className = 'error';
                    msgDom.innerText = 'âŒ æ‚¨æ‹’ç»äº†é’±åŒ…æˆæƒè¿æ¥ï¼';
                    return false;
                }

                // å®ä¾‹åŒ–TronWebï¼Œå¼ºåˆ¶æŒ‡å‘NILEæµ‹è¯•ç½‘ï¼ˆå…³é”®ï¼é˜²æ­¢ç”¨æˆ·åˆ‡åˆ°ä¸»ç½‘ï¼‰
                tronWeb = new window.tronWeb(NILE_NODE_URL, NILE_NODE_URL, NILE_NODE_URL);
                // è·å–å½“å‰é’±åŒ…åœ°å€
                userAddress = tronWeb.defaultAddress.base58;

                // æ ¡éªŒå½“å‰ç½‘ç»œæ˜¯å¦ä¸ºNileæµ‹è¯•ç½‘ï¼ˆæ ¸å¿ƒæ ¡éªŒï¼Œå¿…åŠ ï¼‰
                const chainId = await tronWeb.trx.getChainId();
                // Nileæµ‹è¯•ç½‘çš„chainId = 1; ä¸»ç½‘chainId = 0; Shastaæµ‹è¯•ç½‘chainId=2
                if (chainId !== 1) {
                    msgDom.className = 'error';
                    msgDom.innerText = `âŒ è¯·åˆ‡æ¢è‡³ã€Nileæµ‹è¯•ç½‘ã€‘å†æ“ä½œï¼å½“å‰ç½‘ç»œchainId: ${chainId}`;
                    userAddress = '';
                    return false;
                }

                // è¿æ¥æˆåŠŸ
                msgDom.className = 'success';
                msgDom.innerText = `âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼å½“å‰åœ°å€ï¼š${userAddress} | ç½‘ç»œï¼šNileæµ‹è¯•ç½‘`;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('transferBtn').disabled = false;

            } catch (error) {
                msgDom.className = 'error';
                msgDom.innerText = `âŒ è¿æ¥å¤±è´¥ï¼š${error.message || 'ç”¨æˆ·å–æ¶ˆæˆæƒ'}`;
            }
        }

        // ===================== 2. æ ¸å¿ƒè½¬è´¦é€»è¾‘ =====================
        async function transferTRX() {
            const msgDom = document.getElementById('msg');
            const transferBtn = document.getElementById('transferBtn');
            try {
                // å‰ç½®æ ¡éªŒ
                if (!tronWeb || !userAddress) {
                    msgDom.className = 'error';
                    msgDom.innerText = 'âŒ è¯·å…ˆè¿æ¥é’±åŒ…ï¼';
                    return false;
                }
                transferBtn.disabled = true;
                msgDom.className = 'info';
                msgDom.innerText = 'ğŸ”„ æ­£åœ¨å‘èµ·è½¬è´¦è¯·æ±‚ï¼Œå”¤èµ·TronLinkç­¾åæˆæƒä¸­...';

                // æ ¸å¿ƒï¼šè½¬è´¦æ ¸å¿ƒæ–¹æ³• - trx.sendTransaction
                // æ³¨æ„ï¼šTRXè½¬è´¦å¿…é¡»ä¼  SUN å•ä½ï¼10 TRX = 10 * 1000000 SUN
                const amountInSun = TRX_AMOUNT * SUN_RATIO;
                const transactionObj = await tronWeb.trx.sendTransaction(
                    TO_ADDRESS,  // æ”¶æ¬¾åœ°å€
                    amountInSun  // è½¬è´¦é‡‘é¢ï¼ˆSUNå•ä½ï¼‰
                );

                // âœ… ç­¾åæˆæƒæˆåŠŸï¼Œè¿”å›äº¤æ˜“å¯¹è±¡ï¼ŒåŒ…å«äº¤æ˜“å“ˆå¸Œ
                if (transactionObj && transactionObj.result && transactionObj.txid) {
                    const txHash = transactionObj.txid;
                    msgDom.className = 'success';
                    msgDom.innerText = `âœ… è½¬è´¦ç­¾åæˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š${txHash}\nğŸ’¡ äº¤æ˜“å·²å¹¿æ’­ï¼Œç­‰å¾…åŒºå—ç¡®è®¤ï¼Œå¯å»NileåŒºå—æµè§ˆå™¨æŸ¥è¯¢`;
                    // å¯é€‰ï¼šè·³è½¬åŒºå—æµè§ˆå™¨æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…
                    console.log('äº¤æ˜“å“ˆå¸Œï¼š', txHash);
                    console.log('åŒºå—æµè§ˆå™¨åœ°å€ï¼š', `https://nile.tronscan.org/#/transaction/${txHash}`);
                    return true;
                } else {
                    throw new Error('è½¬è´¦äº¤æ˜“å‘èµ·å¤±è´¥ï¼Œæœªè·å–åˆ°äº¤æ˜“å“ˆå¸Œ');
                }

            } catch (error) {
                transferBtn.disabled = false;
                msgDom.className = 'error';
                const errMsg = error.message || 'è½¬è´¦å¤±è´¥';
                // å¸¸è§é”™è¯¯æ–‡æ¡ˆä¼˜åŒ–
                const tip = errMsg.includes('User denied') ? 'âŒ æ‚¨æ‹’ç»äº†è½¬è´¦ç­¾åæˆæƒ' : 
                            errMsg.includes('insufficient balance') ? 'âŒ é’±åŒ…TRXæµ‹è¯•å¸ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆé¢†å–æµ‹è¯•å¸' : 
                            `âŒ è½¬è´¦å¤±è´¥ï¼š${errMsg}`;
                msgDom.innerText = tip;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹é’±åŒ…æ˜¯å¦å·²è¿æ¥
        window.onload = async () => {
            if (window.tronWeb && window.tronWeb.ready) {
                document.getElementById('msg').innerText = 'â„¹ï¸ æ£€æµ‹åˆ°å·²è¿æ¥çš„TronLinké’±åŒ…ï¼Œç‚¹å‡»è½¬è´¦å³å¯';
                await connectTronLink();
            }
        }
    </script>
</body>
</html>
