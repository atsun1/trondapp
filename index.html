<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TRON Nile USDT è½¬è´¦æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin: 15px 0;
    }
    button {
      width: 100%;
      padding: 16px;
      background: #ffcc00;
      color: black;
      font-weight: bold;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: lime;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ§ª TRON Nile USDT è½¬è´¦æµ‹è¯•</h2>

    <!-- å¤–éƒ¨å¼•å¯¼é¡µé¢ -->
    <div id="externalGuide" style="display:block;">
      <div class="status info">
        <strong>ğŸ“± æ“ä½œè¯´æ˜ï¼š</strong><br>
        è¯·åœ¨ TronLink App çš„ DApp æµè§ˆå™¨ä¸­æ‰“å¼€æœ¬é¡µé¢
      </div>
      
      <button onclick="openInTronLink()">
        ğŸ”— åœ¨ TronLink ä¸­æ‰“å¼€
      </button>
      
      <div style="margin-top:15px; font-size:14px;">
        <strong>å½“å‰ç½‘ç»œï¼š</strong>Nile Testnet<br>
        <strong>è½¬è´¦ä»£å¸ï¼š</strong>USDT<br>
        <strong>ç›®æ ‡åœ°å€ï¼š</strong>TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3<br>
        <strong>é‡‘é¢ï¼š</strong>0.1 USDT
      </div>
    </div>

    <!-- DApp é¡µé¢ -->
    <div id="dappPage" style="display:none;">
      <div class="card">
        <h3>ğŸ’° è½¬è´¦ä¿¡æ¯</h3>
        <p><strong>è½¬è´¦ä»£å¸ï¼š</strong>USDT (Nile Testnet)</p>
        <p><strong>æ”¶æ¬¾åœ°å€ï¼š</strong><code id="recipientAddr">TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3</code></p>
        <p><strong>è½¬è´¦é‡‘é¢ï¼š</strong><span id="amount">0.1</span> USDT</p>
      </div>

      <button id="transferBtn" onclick="transferUSDT()">
        ğŸ’¸ ç«‹å³è½¬è´¦ 0.1 USDT
      </button>

      <div id="status" class="status" style="display:none;"></div>
      <div id="log" class="log" style="display:none;">[æ—¥å¿—] ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script>
    // === é…ç½® ===
    const CONFIG = {
      RECIPIENT: "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3",
      AMOUNT: 0.1, // USDT æ•°é‡
      TOKEN: "USDT" // ä»£å¸åç§°
    };

    // === å·¥å…·å‡½æ•° ===
    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.style.display = 'block';
      logEl.textContent += '\n[LOG] ' + msg;
      console.log(msg);
    }

    function showStatus(text, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = text;
      statusEl.className = 'status ' + type;
      statusEl.style.display = 'block';
    }

    // === å¤–éƒ¨é¡µé¢é€»è¾‘ ===
    function openInTronLink() {
      // å°è¯•å”¤èµ· TronLinkï¼ˆä»…æ‰“å¼€ Appï¼‰
      window.location.href = 'tronlink://';
      
      // æç¤ºç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
      setTimeout(() => {
        alert('è¯·å¤åˆ¶å½“å‰é“¾æ¥ï¼Œåœ¨ TronLink App çš„ã€Œæµè§ˆå™¨ã€ä¸­æ‰“å¼€\n\nå½“å‰é“¾æ¥ï¼š' + window.location.href);
      }, 500);
    }

    // === æ£€æµ‹æ˜¯å¦åœ¨ TronLink ç¯å¢ƒ ===
    function checkTronLinkEnvironment() {
      if (typeof window.tronWeb !== 'undefined') {
        log('âœ… æ£€æµ‹åˆ° TronLink ç¯å¢ƒ');
        
        // æ˜¾ç¤º DApp é¡µé¢ï¼Œéšè—å¼•å¯¼é¡µ
        document.getElementById('externalGuide').style.display = 'none';
        document.getElementById('dappPage').style.display = 'block';
        
        // æ˜¾ç¤ºå½“å‰ç½‘ç»œä¿¡æ¯
        checkNetwork();
        return true;
      }
      return false;
    }

    // === æ£€æµ‹ç½‘ç»œï¼ˆ100% ç¡®è®¤ Nileï¼‰===
    async function checkNetwork() {
      try {
        const tronWeb = window.tronWeb;
        
        // æ–¹æ³• 1: getNetworkType
        let networkType = null;
        try {
          networkType = await tronWeb.trx.getNetworkType();
          log('getNetworkType(): ' + networkType);
        } catch (e) {
          log('getNetworkType å¤±è´¥: ' + e.message);
        }

        if (networkType === 'nile') {
          showStatus('âœ… å½“å‰ç½‘ç»œ: Nile Testnet', 'success');
          return true;
        }

        // æ–¹æ³• 2: getNodeInfo
        try {
          const nodeInfo = await tronWeb.trx.getNodeInfo();
          const netName = nodeInfo.configNodeInfo?.netName || '';
          log('getNodeInfo().netName: ' + netName);
          
          if (/^nile$/i.test(netName)) {
            showStatus('âœ… å½“å‰ç½‘ç»œ: Nile Testnet', 'success');
            return true;
          }
        } catch (e) {
          log('getNodeInfo å¤±è´¥: ' + e.message);
        }

        // æ–¹æ³• 3: æ£€æŸ¥èŠ‚ç‚¹åœ°å€
        try {
          const currentUrl = await tronWeb.trx.getCurrentNode();
          log('å½“å‰èŠ‚ç‚¹: ' + currentUrl);
          
          if (currentUrl.includes('nile')) {
            showStatus('âœ… å½“å‰ç½‘ç»œ: Nile Testnet', 'success');
            return true;
          }
        } catch (e) {
          log('getCurrentNode å¤±è´¥: ' + e.message);
        }

        // å¦‚æœéƒ½ä¸æ˜¯ Nile
        showStatus('âš ï¸ è¯·åˆ‡æ¢åˆ° Nile æµ‹è¯•ç½‘ï¼\næ“ä½œï¼šTronLink â†’ æˆ‘çš„ â†’ è®¾ç½® â†’ ç½‘ç»œ â†’ é€‰æ‹© "Nile"', 'error');
        return false;

      } catch (error) {
        log('ç½‘ç»œæ£€æµ‹å¤±è´¥: ' + error.message);
        showStatus('âŒ ç½‘ç»œæ£€æµ‹å¤±è´¥: ' + error.message, 'error');
        return false;
      }
    }

    // === USDT è½¬è´¦é€»è¾‘ ===
    async function transferUSDT() {
      const btn = document.getElementById('transferBtn');
      btn.disabled = true;
      btn.textContent = 'â³ è½¬è´¦ä¸­...';

      try {
        // 1. æ£€æŸ¥ç¯å¢ƒ
        if (typeof window.tronWeb === 'undefined') {
          throw new Error('æœªæ£€æµ‹åˆ° TronLinkã€‚è¯·åœ¨ TronLink æµè§ˆå™¨ä¸­æ‰“å¼€æœ¬é¡µé¢ã€‚');
        }

        const tronWeb = window.tronWeb;

        // 2. æ£€æŸ¥ç½‘ç»œ
        const isNile = await checkNetwork();
        if (!isNile) {
          throw new Error('å½“å‰ä¸æ˜¯ Nile æµ‹è¯•ç½‘');
        }

        // 3. è·å–å‘é€è€…åœ°å€
        const sender = tronWeb.defaultAddress.base58;
        log('å‘é€è€…åœ°å€: ' + sender);

        // 4. éªŒè¯æ”¶æ¬¾åœ°å€
        if (!tronWeb.isAddress(CONFIG.RECIPIENT)) {
          throw new Error('æ”¶æ¬¾åœ°å€æ— æ•ˆ');
        }

        // 5. USDT è½¬è´¦ï¼ˆå•ä½ï¼šSUNï¼Œ1 USDT = 1,000,000 SUNï¼‰
        const amountInSun = Math.floor(CONFIG.AMOUNT * 1_000_000); // ä¿®å¤ï¼šä½¿ç”¨ Math.floor é¿å…ç²¾åº¦é—®é¢˜
        
        log(`å¼€å§‹è½¬è´¦: ${CONFIG.AMOUNT} USDT (${amountInSun} SUN)`);
        log(`æ”¶æ¬¾åœ°å€: ${CONFIG.RECIPIENT}`);

        // å‘èµ· USDT è½¬è´¦ï¼ˆé€šè¿‡ USDT åˆçº¦ï¼‰
        const usdtContractAddress = 'TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj'; // Nile USDT åˆçº¦åœ°å€
        
        const contract = await tronWeb.contract().at(usdtContractAddress);
        const result = await contract.transfer(CONFIG.RECIPIENT, amountInSun).send();

        log('âœ… è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ' + result);
        showStatus('âœ… è½¬è´¦æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œ: ' + result, 'success');
        
        alert(`âœ… è½¬è´¦æˆåŠŸï¼\n\näº¤æ˜“å“ˆå¸Œ: ${result}\n\nåœ¨ Nile æµè§ˆå™¨æŸ¥çœ‹:\nhttps://nile.tronscan.org/tx/${result}`);

      } catch (error) {
        log('âŒ è½¬è´¦å¤±è´¥: ' + error.message);
        showStatus('âŒ è½¬è´¦å¤±è´¥: ' + error.message, 'error');
        console.error('è½¬è´¦é”™è¯¯:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ’¸ ç«‹å³è½¬è´¦ 0.1 USDT';
      }
    }

    // === é¡µé¢åŠ è½½æ—¶æ£€æµ‹ç¯å¢ƒ ===
    window.addEventListener('load', () => {
      // å¦‚æœåœ¨ TronLink ä¸­æ‰“å¼€ï¼Œæ˜¾ç¤º DApp é¡µé¢
      if (!checkTronLinkEnvironment()) {
        log('âš ï¸ å½“å‰ä¸åœ¨ TronLink ç¯å¢ƒä¸­');
      }
    });
  </script>
</body>
</html>
