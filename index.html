<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”¤èµ·TronLinkè½¬è´¦1TRXï¼ˆNileæµ‹è¯•ç½‘ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { max-width: 500px; margin: 30px auto; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .btn {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            color: white;
        }
        .call-btn { background: #007bff; }
        .transfer-btn { background: #28a745; display: none; }
        .manual-btn { background: #dc3545; }
        .tip {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .warn-tip { background: #f8d7da; color: #721c24; }
        .info-tip { background: #d1ecf1; color: #0c5460; }
        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            min-height: 200px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        #manual-guide { display: none; margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>è½¬è´¦1 TRXåˆ°æŒ‡å®šåœ°å€ï¼ˆNileæµ‹è¯•ç½‘ï¼‰</h2>
        
        <div class="info-tip">
            ğŸ¯ ç›®æ ‡åœ°å€ï¼š<br>
            <code>TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3</code>
        </div>

        <!-- å”¤èµ·é’±åŒ…æŒ‰é’® -->
        <button class="btn call-btn" onclick="callTronLink()">å”¤èµ·TronLinké’±åŒ…</button>
        <!-- æ‰‹åŠ¨è®¿é—®æŒ‡å¼•æŒ‰é’® -->
        <button class="btn manual-btn" onclick="toggleManualGuide()">æ‰‹åŠ¨è®¿é—®æŒ‡å¼•ï¼ˆå”¤èµ·å¤±è´¥æ—¶ç”¨ï¼‰</button>
        <!-- è½¬è´¦æŒ‰é’®ï¼ˆè¿æ¥é’±åŒ…åæ˜¾ç¤ºï¼‰ -->
        <button class="btn transfer-btn" id="transferBtn" onclick="transfer1TRX()">å‘èµ·1 TRXè½¬è´¦</button>

        <!-- æ‰‹åŠ¨è®¿é—®æŒ‡å¼• -->
        <div id="manual-guide" class="warn-tip">
            <h4>ğŸ“ æ‰‹åŠ¨è®¿é—®æ­¥éª¤ï¼ˆå¿…çœ‹ï¼‰</h4>
            <ol>
                <li>æ‰“å¼€TronLink â†’ åˆ‡æ¢åˆ°ã€ŒNileæµ‹è¯•ç½‘ã€â†’ ç¡®ä¿æœ‰æµ‹è¯•TRXï¼ˆæ°´é¾™å¤´é¢†å–ï¼‰ï¼›</li>
                <li>è¿›å…¥TronLinkåº•éƒ¨ã€Œå‘ç°ã€â†’ã€ŒDAppæµè§ˆå™¨ã€ï¼›</li>
                <li>è¾“å…¥DAppåœ°å€ï¼š<span id="dapp-url">http://192.168.1.100:8080/tron-transfer-1trx.html</span>ï¼›</li>
                <li>è®¿é—®åç‚¹å‡»ã€Œè¿æ¥é’±åŒ…ã€â†’ å‘èµ·è½¬è´¦ã€‚</li>
            </ol>
        </div>

        <!-- è°ƒè¯•æ—¥å¿—åŒº -->
        <div id="log">[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å”¤èµ·TronLink...</div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰ ==========
        const LOCAL_IP = "192.168.1.100"; // æ›¿æ¢ä¸ºä½ çš„ç”µè„‘å±€åŸŸç½‘IP
        const LOCAL_PORT = 8080;
        const DAPP_URL = `http://${LOCAL_IP}:${LOCAL_PORT}/tron-transfer-1trx.html`;
        const TARGET_ADDRESS = "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3"; // ç›®æ ‡è½¬è´¦åœ°å€
        const TRANSFER_AMOUNT = 1; // è½¬è´¦1 TRX
        const NILE_CHAIN_ID = "4"; // Nileæµ‹è¯•ç½‘é“¾ID

        let tronWeb = null;
        document.getElementById("dapp-url").textContent = DAPP_URL;

        // ========== å·¥å…·å‡½æ•°ï¼šå¯è§†åŒ–æ—¥å¿—ï¼ˆå…³é”®è°ƒè¯•ï¼‰ ==========
        function log(msg) {
            const logEl = document.getElementById("log");
            const time = new Date().toLocaleTimeString();
            const logMsg = `[${time}] ${msg}`;
            // é¡µé¢æ˜¾ç¤ºæ—¥å¿—
            logEl.innerHTML += logMsg + "\n";
            logEl.scrollTop = logEl.scrollHeight;
            // æ§åˆ¶å°è¾“å‡º
            console.log(logMsg);
            // å…³é”®æŠ¥é”™å¼¹æ¡†æé†’
            if (msg.includes("âŒ") || msg.includes("Error") || msg.includes("Failed")) {
                alert(`ã€æŠ¥é”™ã€‘${msg}`);
            }
        }

        // æ˜¾ç¤º/éšè—æ‰‹åŠ¨æŒ‡å¼•
        function toggleManualGuide() {
            const guide = document.getElementById("manual-guide");
            guide.style.display = guide.style.display === "none" ? "block" : "none";
        }

        // ========== æ ¸å¿ƒ1ï¼šå”¤èµ·TronLinkï¼ˆå¤šåè®®å…¼å®¹ï¼‰ ==========
        function callTronLink() {
            log("===== å¼€å§‹å”¤èµ·TronLink =====");
            // æ£€æµ‹æ˜¯å¦å·²åœ¨TronLinkå†…ç½®æµè§ˆå™¨
            if (window.tronWeb) {
                log("âœ… å·²åœ¨TronLinkå†…ç½®æµè§ˆå™¨ï¼Œæ— éœ€å”¤èµ·ï¼Œç›´æ¥è¿æ¥é’±åŒ…");
                connectWallet();
                return;
            }

            // å¤šåè®®å…¼å®¹ï¼ˆè§£å†³é›·ç”µæ¨¡æ‹Ÿå™¨å”¤èµ·å¤±è´¥ï¼‰
            const deepLink1 = `tronlink://dapp?url=${encodeURIComponent(DAPP_URL)}`; // æ—§åè®®
            const deepLink2 = `tron://open?type=dapp&url=${encodeURIComponent(DAPP_URL)}`; // æ–°åè®®

            try {
                log(`ğŸ”„ å°è¯•æ–°åè®®å”¤èµ·ï¼š${deepLink2}`);
                window.location.href = deepLink2;
                // 1.5ç§’åé™çº§å°è¯•æ—§åè®®
                setTimeout(() => {
                    if (!window.tronWeb) {
                        log(`ğŸ”„ æ–°åè®®å”¤èµ·å¤±è´¥ï¼Œå°è¯•æ—§åè®®ï¼š${deepLink1}`);
                        window.location.href = deepLink1;
                    }
                }, 1500);

                log("âš ï¸ è‹¥é’±åŒ…æœªå”¤èµ·ï¼Œè¯·æŸ¥çœ‹ã€Œæ‰‹åŠ¨è®¿é—®æŒ‡å¼•ã€ï¼Œæ‰‹åŠ¨åœ¨TronLinkä¸­æ‰“å¼€DApp");
            } catch (e) {
                log(`âŒ å”¤èµ·å¤±è´¥ï¼š${e.message}`);
                toggleManualGuide(); // è‡ªåŠ¨æ˜¾ç¤ºæ‰‹åŠ¨æŒ‡å¼•
            }
        }

        // ========== æ ¸å¿ƒ2ï¼šè¿æ¥é’±åŒ…ï¼ˆé€‚é…æ–°ç‰ˆTronLinkï¼‰ ==========
        async function connectWallet() {
            log("===== å¼€å§‹è¿æ¥é’±åŒ… =====");
            // æ£€æµ‹TronLinkç¯å¢ƒ
            if (!window.tronWeb) {
                log("âŒ æœªæ£€æµ‹åˆ°TronLinkç¯å¢ƒï¼è¯·æŒ‰æ‰‹åŠ¨æŒ‡å¼•æ“ä½œ");
                alert("è¯·åœ¨TronLinkå†…ç½®DAppæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢ï¼");
                toggleManualGuide();
                return;
            }

            try {
                tronWeb = window.tronWeb;
                // æ ¡éªŒTronLinkç‰ˆæœ¬
                if (!tronWeb.request) {
                    log("âŒ TronLinkç‰ˆæœ¬è¿‡ä½ï¼Œè¯·å‡çº§åˆ°V4+");
                    alert("è¯·å‡çº§TronLinkåˆ°æœ€æ–°ç‰ˆæœ¬ï¼");
                    return;
                }

                // å‘èµ·é’±åŒ…æˆæƒ
                log("ğŸ”„ å‘èµ·é’±åŒ…æˆæƒè¯·æ±‚...");
                const accounts = await tronWeb.request({
                    method: "tron_requestAccounts",
                    params: [] // æ–°ç‰ˆå¿…å¡«ç©ºå‚æ•°
                });

                if (!accounts || accounts.length === 0) {
                    log("âŒ ç”¨æˆ·æ‹’ç»æˆæƒè¿æ¥é’±åŒ…");
                    return;
                }

                // æ ¡éªŒæ˜¯å¦ä¸ºNileæµ‹è¯•ç½‘
                const chainId = String(await tronWeb.trx.getChainId());
                if (chainId !== NILE_CHAIN_ID) {
                    log(`âŒ å½“å‰ç½‘ç»œä¸æ˜¯Nileæµ‹è¯•ç½‘ï¼å½“å‰é“¾IDï¼š${chainId}ï¼Œéœ€è¦ï¼š${NILE_CHAIN_ID}`);
                    alert("è¯·å°†TronLinkåˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘ï¼");
                    return;
                }

                // éªŒè¯ç›®æ ‡åœ°å€æ ¼å¼
                if (!tronWeb.address.isValid(TARGET_ADDRESS)) {
                    log(`âŒ ç›®æ ‡åœ°å€${TARGET_ADDRESS}æ ¼å¼é”™è¯¯`);
                    alert("ç›®æ ‡è½¬è´¦åœ°å€æ ¼å¼é”™è¯¯ï¼");
                    return;
                }

                // è¿æ¥æˆåŠŸï¼Œæ˜¾ç¤ºè½¬è´¦æŒ‰é’®
                const address = tronWeb.address.fromHex(tronWeb.defaultAddress.base58);
                log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€ï¼š${address}`);
                log(`âœ… å½“å‰ç½‘ç»œï¼šNileæµ‹è¯•ç½‘ï¼ˆé“¾IDï¼š${chainId}ï¼‰`);
                document.getElementById("transferBtn").style.display = "block";

            } catch (e) {
                log(`âŒ è¿æ¥é’±åŒ…å¤±è´¥ï¼š${e.message}`);
                alert(`è¿æ¥å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ========== æ ¸å¿ƒ3ï¼šè½¬è´¦1 TRXï¼ˆNileæµ‹è¯•ç½‘ï¼‰ ==========
        async function transfer1TRX() {
            log("===== å¼€å§‹è½¬è´¦1 TRX =====");
            if (!tronWeb || !tronWeb.ready) {
                log("âŒ é’±åŒ…æœªå°±ç»ªï¼Œè¯·å…ˆè¿æ¥é’±åŒ…");
                alert("é’±åŒ…æœªè¿æ¥ï¼");
                return;
            }

            try {
                // è½¬æ¢TRXä¸ºSunï¼ˆ1 TRX = 1000000 Sunï¼‰
                const amountInSun = tronWeb.toSun(TRANSFER_AMOUNT);
                log(`ğŸ“¤ å‡†å¤‡è½¬è´¦ï¼š${TRANSFER_AMOUNT} TRXï¼ˆ${amountInSun} Sunï¼‰â†’ ${TARGET_ADDRESS}`);
                log("ğŸ”„ å‘èµ·è½¬è´¦è¯·æ±‚ï¼Œç­‰å¾…ç”¨æˆ·åœ¨TronLinkç¡®è®¤...");

                // å‘èµ·è½¬è´¦ï¼ˆæ–°ç‰ˆç®€åŒ–å‚æ•°ï¼Œä¾èµ–é’±åŒ…é»˜è®¤é…ç½®ï¼‰
                const transaction = await tronWeb.trx.sendTransaction(
                    TARGET_ADDRESS,
                    amountInSun
                );

                // è½¬è´¦æˆåŠŸ
                log(`âœ… è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}`);
                log(`ğŸ” åŒºå—æµè§ˆå™¨æŸ¥çœ‹ï¼šhttps://nile.tronscan.org/#/transaction/${transaction.txid}`);
                alert(`è½¬è´¦1 TRXæˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}\nå¯åœ¨NileåŒºå—æµè§ˆå™¨æŸ¥çœ‹`);

            } catch (e) {
                log(`âŒ è½¬è´¦å¤±è´¥ï¼š${e.message}`);
                alert(`è½¬è´¦å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        window.onload = function() {
            log(`ğŸ“± DAppåœ°å€ï¼š${DAPP_URL}`);
            log("ğŸ’¡ æç¤ºï¼šè‹¥å”¤èµ·æ— ååº”ï¼Œä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è®¿é—®æŒ‡å¼•");
            // è‡ªåŠ¨æ£€æµ‹æ˜¯å¦å·²åœ¨TronLinkå†…ç½®æµè§ˆå™¨
            if (window.tronWeb) {
                setTimeout(connectWallet, 1000);
            }
        };
    </script>
</body>
</html>
