<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRONé’±åŒ…äº¤äº’ï¼ˆé›·ç¥æ¨¡æ‹Ÿå™¨+Nileæµ‹è¯•ç½‘ï¼‰</title>
    <style>
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            width: 100%;
            font-size: 16px;
        }
        button.manual {
            background: #dc3545;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #walletInfo, #transferArea {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px dashed #eee;
            display: none;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            min-height: 150px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .tip {
            color: #dc3545;
            font-size: 14px;
            margin: 15px 0;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
        }
        .normal-tip {
            color: #666;
            font-size: 12px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>TRONé’±åŒ…DAppäº¤äº’ï¼ˆNileæµ‹è¯•ç½‘ï¼‰</h2>
        <div class="tip">
            ğŸ“¢ é€‚é…é›·ç¥æ¨¡æ‹Ÿå™¨ï¼ˆå®‰å“9ï¼‰+ TronLink<br>
            è‹¥å”¤èµ·æ— ååº”ï¼Œè¯·ç‚¹å‡»ã€Œæ‰‹åŠ¨è®¿é—®æŒ‡å¼•ã€æŒ‰æ­¥éª¤æ“ä½œ
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <button onclick="openInTronLink()">å°è¯•å”¤èµ·TronLinké’±åŒ…</button>
        <button class="manual" onclick="showManualGuide()">æ‰‹åŠ¨è®¿é—®æŒ‡å¼•</button>
        <button onclick="checkWalletConnection()">æ£€æµ‹é’±åŒ…è¿æ¥çŠ¶æ€</button>

        <!-- æ‰‹åŠ¨æŒ‡å¼•å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="manualGuide" style="display: none; margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px;">
            <h4>ğŸ“ æ‰‹åŠ¨è®¿é—®æ­¥éª¤ï¼ˆå¿…çœ‹ï¼‰</h4>
            <ol>
                <li>æ‰“å¼€TronLinkï¼ˆå®‰å“ç‰ˆï¼‰â†’ åˆ‡æ¢åˆ°ã€ŒNileæµ‹è¯•ç½‘ã€â†’ ç¡®ä¿å·²é¢†å–æµ‹è¯•TRX</li>
                <li>ç‚¹å‡»TronLinkåº•éƒ¨ã€Œå‘ç°ã€â†’ è¿›å…¥ã€ŒDAppæµè§ˆå™¨ã€</li>
                <li>åœ¨åœ°å€æ è¾“å…¥ï¼š<span id="dappUrlText">http://192.168.1.100:8080/tron-dapp.html</span></li>
                <li>å›è½¦è®¿é—®ï¼Œå³å¯è‡ªåŠ¨è¿æ¥é’±åŒ…</li>
            </ol>
            <button onclick="hideManualGuide()" style="background: #6c757d; margin-top: 10px;">å…³é—­æŒ‡å¼•</button>
        </div>

        <!-- é’±åŒ…ä¿¡æ¯ -->
        <div id="walletInfo">
            <p>å½“å‰è´¦æˆ·åœ°å€ï¼š<span id="address">--</span></p>
            <p>TRXä½™é¢ï¼š<span id="trxBalance">--</span> TRX</p>
            <p class="normal-tip">å½“å‰ç½‘ç»œï¼šNileæµ‹è¯•ç½‘</p>
        </div>

        <!-- è½¬è´¦åŒºåŸŸ -->
        <div id="transferArea">
            <h4>TRC20ä»£å¸è½¬è´¦ï¼ˆNileæµ‹è¯•ç½‘USDTï¼‰</h4>
            <div>
                <label>æ¥æ”¶åœ°å€ï¼š</label>
                <input type="text" id="toAddress" placeholder="è¾“å…¥TRONåœ°å€" value="TN3W4H6rK2ce4vX9YnFQHwKENnHjoxb3m9">
                <p class="normal-tip">Nileæµ‹è¯•ç½‘USDTåˆçº¦åœ°å€ï¼šTN3W4H6rK2ce4vX9YnFQHwKENnHjoxb3m9</p>
            </div>
            <div>
                <label>è½¬è´¦æ•°é‡ï¼š</label>
                <input type="number" id="amount" placeholder="è¾“å…¥æ•°é‡ï¼ˆå¦‚0.01ï¼‰" value="0.01">
            </div>
            <button onclick="transferTRC20()">å‘èµ·è½¬è´¦</button>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div id="log">[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·å…ˆç¡®ä¿TronLinkåˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘</div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰ ==========
        // 1. æ›¿æ¢ä¸ºä½ çš„ç”µè„‘å±€åŸŸç½‘IPï¼ˆå¦‚192.168.1.100ï¼‰ï¼Œç«¯å£ä¸æœ¬åœ°æœåŠ¡å™¨ä¸€è‡´
        const LOCAL_IP = "192.168.1.100";
        const LOCAL_PORT = 8080;
        const LOCAL_DAPP_URL = `http://${LOCAL_IP}:${LOCAL_PORT}/tron-dapp.html`;

        // 2. Nileæµ‹è¯•ç½‘é…ç½®ï¼ˆé€‚é…ä½ çš„ç¯å¢ƒï¼‰
        const TRON_CONFIG = {
            nile: {
                fullHost: 'https://nile.trongrid.io',       // Nileæµ‹è¯•ç½‘èŠ‚ç‚¹
                usdtContract: 'TN3W4H6rK2ce4vX9YnFQHwKENnHjoxb3m9', // Nileæµ‹è¯•ç½‘USDTåˆçº¦
                tronscanUrl: 'https://nile.tronscan.org/'    // Nileæµ‹è¯•ç½‘åŒºå—æµè§ˆå™¨
            }
        };
        const currentNetwork = TRON_CONFIG.nile;
        let tronWeb = null;

        // ========== å·¥å…·å‡½æ•° ==========
        // æ—¥å¿—è¾“å‡º
        function log(message) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨ä¸­
        function isInWalletBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            return userAgent.includes('tronlink') || userAgent.includes('tokenpocket');
        }

        // æ˜¾ç¤º/éšè—æ‰‹åŠ¨æŒ‡å¼•
        function showManualGuide() {
            document.getElementById('manualGuide').style.display = 'block';
            document.getElementById('dappUrlText').textContent = LOCAL_DAPP_URL;
            log("æ˜¾ç¤ºæ‰‹åŠ¨è®¿é—®æŒ‡å¼•ï¼šè‹¥å”¤èµ·æ— ååº”ï¼Œè¯·æŒ‰æŒ‡å¼•æ‰‹åŠ¨æ“ä½œ");
        }
        function hideManualGuide() {
            document.getElementById('manualGuide').style.display = 'none';
        }

        // ========== å”¤èµ·é’±åŒ…å‡½æ•°ï¼ˆå…¼å®¹ç‰ˆï¼‰ ==========
        function openInTronLink() {
            if (isInWalletBrowser()) {
                log("âœ… å·²åœ¨TronLinkå†…ç½®æµè§ˆå™¨ä¸­ï¼Œæ— éœ€é‡å¤å”¤èµ·");
                checkWalletConnection();
                return;
            }
            // å…¼å®¹TronLinkå®‰å“ç‰ˆçš„å¤šåè®®å°è¯•
            const deepLink1 = `tronlink://dapp?url=${encodeURIComponent(LOCAL_DAPP_URL)}`; // æ—§åè®®
            const deepLink2 = `tron://open?type=dapp&url=${encodeURIComponent(LOCAL_DAPP_URL)}`; // æ–°åè®®
            // å…ˆå°è¯•æ–°åè®®ï¼Œå†é™çº§æ—§åè®®
            try {
                window.location.href = deepLink2;
                log("ğŸ”„ å°è¯•ç”¨æ–°åè®®å”¤èµ·TronLink...è‹¥æ— ååº”ï¼Œè¯·æŸ¥çœ‹æ‰‹åŠ¨æŒ‡å¼•");
                // é™çº§å…œåº•
                setTimeout(() => {
                    if (!isInWalletBrowser()) {
                        window.location.href = deepLink1;
                    }
                }, 1500);
            } catch (e) {
                log(`âš ï¸ å”¤èµ·å¤±è´¥ï¼š${e.message}ï¼Œè¯·æ‰‹åŠ¨åœ¨TronLinkä¸­æ‰“å¼€DApp`);
            }
        }

        // ========== é’±åŒ…æ ¸å¿ƒäº¤äº’å‡½æ•° ==========
        // æ£€æµ‹é’±åŒ…è¿æ¥çŠ¶æ€
        async function checkWalletConnection() {
            try {
                // æ£€æµ‹tronWebæ˜¯å¦æ³¨å…¥ï¼ˆé’±åŒ…å†…ç½®æµè§ˆå™¨ä¼šè‡ªåŠ¨æ³¨å…¥ï¼‰
                if (!window.tronWeb) {
                    log("âŒ æœªæ£€æµ‹åˆ°TRONé’±åŒ…ç¯å¢ƒï¼è¯·æŒ‰æ‰‹åŠ¨æŒ‡å¼•æ“ä½œ");
                    alert("è¯·å…ˆåœ¨TronLinkå†…ç½®æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢ï¼");
                    showManualGuide(); // è‡ªåŠ¨æ˜¾ç¤ºæ‰‹åŠ¨æŒ‡å¼•
                    return;
                }

                // åˆå§‹åŒ–tronWebå¹¶ç»‘å®šNileæµ‹è¯•ç½‘
                tronWeb = window.tronWeb;
                tronWeb.setCurrentNode({
                    fullHost: currentNetwork.fullHost,
                    chainUrl: currentNetwork.fullHost,
                    eventServer: currentNetwork.fullHost
                });

                // éªŒè¯é’±åŒ…æ˜¯å¦å°±ç»ªä¸”ç½‘ç»œåŒ¹é…
                if (!tronWeb.ready) {
                    log("âŒ é’±åŒ…æœªå°±ç»ªï¼è¯·æ£€æŸ¥ï¼š1.TronLinkå·²ç™»å½• 2.åˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘");
                    alert("é’±åŒ…æœªå°±ç»ªï¼Œè¯·ç¡®è®¤Nileæµ‹è¯•ç½‘å·²åˆ‡æ¢ï¼");
                    return;
                }

                // éªŒè¯ç½‘ç»œæ˜¯å¦ä¸ºNile
                const nodeInfo = await tronWeb.trx.getNodeInfo();
                if (!nodeInfo.node_version.includes('nile')) {
                    log("âŒ å½“å‰é’±åŒ…ç½‘ç»œä¸æ˜¯Nileæµ‹è¯•ç½‘ï¼è¯·åˆ‡æ¢åé‡è¯•");
                    alert("è¯·å°†TronLinkåˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘ï¼");
                    return;
                }

                // è·å–é’±åŒ…åœ°å€å’Œä½™é¢
                const address = tronWeb.address.fromHex(tronWeb.defaultAddress.base58);
                log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€ï¼š${address}`);
                
                // æ˜¾ç¤ºé’±åŒ…ä¿¡æ¯å’Œè½¬è´¦åŒºåŸŸ
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('address').textContent = address;
                document.getElementById('transferArea').style.display = 'block';

                // æŸ¥è¯¢TRXä½™é¢
                await getTRXBalance(address);

            } catch (error) {
                log(`âŒ æ£€æµ‹é’±åŒ…å¤±è´¥ï¼š${error.message}`);
                alert(`æ£€æµ‹å¤±è´¥ï¼š${error.message}`);
            }
        }

        // æŸ¥è¯¢TRXä½™é¢ï¼ˆNileæµ‹è¯•ç½‘ï¼‰
        async function getTRXBalance(address) {
            try {
                const balanceInSun = await tronWeb.trx.getBalance(address);
                const balanceInTRX = tronWeb.fromSun(balanceInSun); // Sunè½¬TRXï¼ˆ1TRX=10^6Sunï¼‰
                document.getElementById('trxBalance').textContent = balanceInTRX;
                log(`âœ… TRXä½™é¢æŸ¥è¯¢æˆåŠŸï¼š${balanceInTRX} TRXï¼ˆNileæµ‹è¯•ç½‘ï¼‰`);
            } catch (error) {
                log(`âš ï¸ æŸ¥è¯¢ä½™é¢å¤±è´¥ï¼š${error.message}`);
            }
        }

        // TRC20ä»£å¸è½¬è´¦ï¼ˆNileæµ‹è¯•ç½‘USDTï¼‰
        async function transferTRC20() {
            try {
                if (!tronWeb || !tronWeb.ready) {
                    log("âŒ é’±åŒ…æœªè¿æ¥ï¼Œè¯·å…ˆæ£€æµ‹é’±åŒ…çŠ¶æ€");
                    alert("é’±åŒ…æœªå°±ç»ªï¼");
                    return;
                }

                // è·å–è¾“å…¥å‚æ•°
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = document.getElementById('amount').value.trim();

                // ä¸¥æ ¼å‚æ•°æ ¡éªŒ
                if (!tronWeb.address.isValid(toAddress)) {
                    log("âŒ æ¥æ”¶åœ°å€æ ¼å¼é”™è¯¯");
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„TRONåœ°å€ï¼");
                    return;
                }
                if (!amount || isNaN(amount) || Number(amount) <= 0) {
                    log("âŒ è½¬è´¦æ•°é‡é”™è¯¯");
                    alert("è¯·è¾“å…¥å¤§äº0çš„æœ‰æ•ˆæ•°é‡ï¼");
                    return;
                }

                // åŠ è½½Nileæµ‹è¯•ç½‘USDTåˆçº¦
                const contract = await tronWeb.contract().at(currentNetwork.usdtContract);
                // USDTå°æ•°ä½ä¸º6ä½ï¼Œè½¬æ¢ä¸ºæœ€å°å•ä½
                const decimals = 6;
                const amountInSmallestUnit = tronWeb.toBigNumber(amount).times(10 ** decimals).toFixed(0);

                log(`ğŸ“¤ å‘èµ·USDTè½¬è´¦ï¼š${amount} USDT -> ${toAddress}ï¼ˆNileæµ‹è¯•ç½‘ï¼‰`);
                log("âŒ› ç­‰å¾…ç”¨æˆ·åœ¨TronLinkä¸­ç¡®è®¤äº¤æ˜“...");

                // å‘èµ·è½¬è´¦äº¤æ˜“ï¼ˆè®¾ç½®è¶³å¤Ÿæ‰‹ç»­è´¹ï¼‰
                const result = await contract.transfer(toAddress, amountInSmallestUnit).send({
                    from: tronWeb.defaultAddress.base58,
                    feeLimit: 500000000, // æ‰‹ç»­è´¹ä¸Šé™ï¼ˆSunï¼ŒNileæµ‹è¯•ç½‘å¯é€‚å½“è°ƒé«˜ï¼‰
                    callValue: 0,
                    shouldPollResponse: true // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                });

                // äº¤æ˜“æˆåŠŸ
                log(`âœ… è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š${result.transaction}`);
                log(`ğŸ” åŒºå—æµè§ˆå™¨æŸ¥çœ‹ï¼š${currentNetwork.tronscanUrl}#/transaction/${result.transaction}`);
                alert(`è½¬è´¦æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œï¼š${result.transaction}\nå¯åœ¨NileåŒºå—æµè§ˆå™¨æŸ¥çœ‹`);

            } catch (error) {
                log(`âŒ è½¬è´¦å¤±è´¥ï¼š${error.message}`);
                alert(`è½¬è´¦å¤±è´¥ï¼š${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            // æ˜¾ç¤ºå½“å‰DAppåœ°å€
            document.getElementById('dappUrlText').textContent = LOCAL_DAPP_URL;
            // æ£€æµ‹å½“å‰ç¯å¢ƒ
            const envTip = isInWalletBrowser() ? "âœ… é’±åŒ…å†…ç½®æµè§ˆå™¨" : "âŒ æ™®é€šæµè§ˆå™¨";
            log(`ğŸ“± å½“å‰ç¯å¢ƒï¼š${envTip}`);
            // è‡ªåŠ¨æ£€æµ‹é’±åŒ…ï¼ˆè‹¥å·²åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨ï¼‰
            if (isInWalletBrowser()) {
                setTimeout(checkWalletConnection, 1000);
            }
        };
    </script>
</body>
</html>
