<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRONè½¬è´¦æ¡ˆä¾‹ï¼ˆNileæµ‹è¯•ç½‘ï¼‰</title>
    <style>
        .container {
            max-width: 500px;
            margin: 30px auto;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            min-height: 150px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        .tip {
            color: #dc3545;
            font-size: 14px;
            margin: 10px 0;
            padding: 8px;
            background: #f8d7da;
            border-radius: 4px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>TRXè½¬è´¦ï¼ˆNileæµ‹è¯•ç½‘ï¼‰</h2>
        <div class="tip">
            ğŸ“¢ è¯·å…ˆåœ¨TronLinkå†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢<br>
            åœ°å€ï¼š<span id="dappUrl">http://192.168.1.100:8080/tron-transfer.html</span>
        </div>

        <!-- è¿æ¥é’±åŒ…æŒ‰é’® -->
        <button id="connectBtn" onclick="connectWallet()">è¿æ¥TronLinké’±åŒ…</button>

        <!-- è½¬è´¦åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="transferArea" style="display: none;">
            <div>
                <label>æ¥æ”¶åœ°å€ï¼š</label>
                <input type="text" id="toAddress" placeholder="è¾“å…¥Nileæµ‹è¯•ç½‘åœ°å€" value="TN3W4H6rK2ce4vX9YnFQHwKENnHjoxb3m9">
            </div>
            <div>
                <label>è½¬è´¦æ•°é‡ï¼ˆTRXï¼‰ï¼š</label>
                <input type="number" id="amount" placeholder="è¾“å…¥è½¬è´¦æ•°é‡ï¼ˆå¦‚0.1ï¼‰" value="0.1">
            </div>
            <button onclick="transferTRX()">å‘èµ·è½¬è´¦</button>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div id="log">[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·å…ˆè¿æ¥é’±åŒ…</div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰ ==========
        // æ›¿æ¢ä¸ºä½ çš„ç”µè„‘å±€åŸŸç½‘IPï¼ˆå¦‚192.168.1.100ï¼‰
        const LOCAL_IP = "192.168.1.100";
        const LOCAL_PORT = 8080;
        const DAPP_URL = `http://${LOCAL_IP}:${LOCAL_PORT}/tron-transfer.html`;
        
        // Nileæµ‹è¯•ç½‘é…ç½®
        const NILE_CONFIG = {
            fullHost: 'https://nile.trongrid.io',
            chainId: '4' // Nileæµ‹è¯•ç½‘é“¾ID
        };

        let tronWeb = null;
        // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„DAppåœ°å€
        document.getElementById('dappUrl').textContent = DAPP_URL;

        // ========== å·¥å…·å‡½æ•° ==========
        // æ—¥å¿—è¾“å‡ºï¼ˆå¯è§†åŒ–+æ§åˆ¶å°åŒè¾“å‡ºï¼‰
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${time}] ${msg}`); // æ§åˆ¶å°ä¹Ÿè¾“å‡ºï¼Œæ–¹ä¾¿è°ƒè¯•
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨TronLinkå†…ç½®æµè§ˆå™¨
        function checkTronLinkEnv() {
            if (!window.tronWeb) {
                log("âŒ æœªæ£€æµ‹åˆ°TronLinkç¯å¢ƒï¼è¯·åœ¨TronLinkå†…ç½®æµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢");
                alert("è¯·åœ¨TronLinkå†…ç½®DAppæµè§ˆå™¨ä¸­è®¿é—®æ­¤é¡µé¢ï¼");
                return false;
            }
            log("âœ… æ£€æµ‹åˆ°TronLinkå†…ç½®æµè§ˆå™¨ç¯å¢ƒ");
            return true;
        }

        // ========== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==========
        // 1. è¿æ¥TronLinké’±åŒ…
        async function connectWallet() {
            // å…ˆæ£€æŸ¥ç¯å¢ƒ
            if (!checkTronLinkEnv()) return;

            try {
                tronWeb = window.tronWeb;
                // ç»‘å®šNileæµ‹è¯•ç½‘èŠ‚ç‚¹
                tronWeb.setCurrentNode({
                    fullHost: NILE_CONFIG.fullHost,
                    chainId: NILE_CONFIG.chainId
                });

                // å‘èµ·é’±åŒ…æˆæƒè¯·æ±‚ï¼ˆè§¦å‘TronLinkæˆæƒå¼¹çª—ï¼‰
                log("ğŸ”„ å‘èµ·é’±åŒ…è¿æ¥è¯·æ±‚...");
                const accounts = await tronWeb.request({ method: 'tron_requestAccounts' });
                
                if (!accounts || accounts.length === 0) {
                    log("âŒ ç”¨æˆ·æ‹’ç»æˆæƒè¿æ¥é’±åŒ…");
                    return;
                }

                // è·å–é’±åŒ…åœ°å€ï¼ˆæ ¼å¼åŒ–ï¼‰
                const address = tronWeb.address.fromHex(tronWeb.defaultAddress.base58);
                log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€ï¼š${address}`);
                log(`âœ… å½“å‰ç½‘ç»œï¼šNileæµ‹è¯•ç½‘ï¼ˆé“¾IDï¼š${NILE_CONFIG.chainId}ï¼‰`);
                
                // æ˜¾ç¤ºè½¬è´¦åŒºåŸŸ
                document.getElementById('transferArea').style.display = 'block';
                // ç¦ç”¨è¿æ¥æŒ‰é’®
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = "å·²è¿æ¥é’±åŒ…";

            } catch (error) {
                log(`âŒ è¿æ¥é’±åŒ…å¤±è´¥ï¼š${error.message}`);
                alert(`è¿æ¥å¤±è´¥ï¼š${error.message}`);
            }
        }

        // 2. å‘èµ·TRXè½¬è´¦ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
        async function transferTRX() {
            if (!tronWeb || !tronWeb.ready) {
                log("âŒ é’±åŒ…æœªå°±ç»ªï¼Œè¯·å…ˆè¿æ¥é’±åŒ…");
                alert("é’±åŒ…æœªè¿æ¥ï¼");
                return;
            }

            try {
                // è·å–è¾“å…¥å‚æ•°
                const toAddress = document.getElementById('toAddress').value.trim();
                const amount = document.getElementById('amount').value.trim();

                // å‚æ•°æ ¡éªŒ
                if (!tronWeb.address.isValid(toAddress)) {
                    log("âŒ æ¥æ”¶åœ°å€æ ¼å¼é”™è¯¯");
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„Nileæµ‹è¯•ç½‘åœ°å€ï¼");
                    return;
                }
                if (!amount || isNaN(amount) || Number(amount) <= 0) {
                    log("âŒ è½¬è´¦æ•°é‡é”™è¯¯ï¼ˆéœ€å¤§äº0ï¼‰");
                    alert("è¯·è¾“å…¥å¤§äº0çš„è½¬è´¦æ•°é‡ï¼");
                    return;
                }

                // è½¬æ¢é‡‘é¢ä¸ºSunï¼ˆ1 TRX = 10^6 Sunï¼‰
                const amountInSun = tronWeb.toSun(amount);
                log(`ğŸ“¤ å‡†å¤‡è½¬è´¦ï¼š${amount} TRXï¼ˆ${amountInSun} Sunï¼‰â†’ ${toAddress}`);
                log("ğŸ”„ å‘èµ·è½¬è´¦è¯·æ±‚ï¼Œç­‰å¾…ç”¨æˆ·åœ¨TronLinkç¡®è®¤...");

                // è°ƒç”¨tronWebå‘èµ·è½¬è´¦ï¼ˆè§¦å‘TronLinkä»˜æ¬¾ç¡®è®¤å¼¹çª—ï¼‰
                const transaction = await tronWeb.trx.sendTransaction(
                    toAddress,
                    amountInSun,
                    {
                        feeLimit: 100000000, // æ‰‹ç»­è´¹ä¸Šé™ï¼ˆSunï¼‰
                        shouldPollResponse: true // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    }
                );

                // äº¤æ˜“å¹¿æ’­æˆåŠŸ
                log(`âœ… è½¬è´¦äº¤æ˜“å·²å¹¿æ’­ï¼äº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}`);
                log(`ğŸ” åŒºå—æµè§ˆå™¨æŸ¥çœ‹ï¼šhttps://nile.tronscan.org/#/transaction/${transaction.txid}`);
                alert(`è½¬è´¦æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}\nå¯åœ¨NileåŒºå—æµè§ˆå™¨æŸ¥çœ‹`);

            } catch (error) {
                log(`âŒ è½¬è´¦å¤±è´¥ï¼š${error.message}`);
                alert(`è½¬è´¦å¤±è´¥ï¼š${error.message}`);
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        window.onload = function() {
            log(`ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼ŒDAppåœ°å€ï¼š${DAPP_URL}`);
            // è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
            checkTronLinkEnv();
        };
    </script>
</body>
</html>
