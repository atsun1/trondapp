<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>âœ… TRON Multisig (Fixed Field Names)</title>
</head>
<body>
  <button onclick="run()">æµ‹è¯•ç­¾ç­¾</button>
  <pre id="log" style="background:#1e1e1e;color:#00ff00;padding:10px;"></pre>

  <script>
    async function log(msg) {
      document.getElementById('log').textContent += '[LOG] ' + msg + '\n';
    }

    async function run() {
      if (!window.tronLink) return log('âŒ æœªå®‰è£… TronLink');

      await window.tronLink.request({ method: 'tron_requestAccounts' });
      const tronWeb = window.tronWeb;
      const account = tronWeb.defaultAddress.base58;
      const ownerHex = tronWeb.address.toHex(account).replace(/^0x/i, '').toLowerCase();

      // å¤šç­¾åœ°å€ï¼ˆæ›¿æ¢ä¸ºä½ è‡ªå·±çš„ï¼‰
      const multisigAddrs = [
        "TDx8EWSQKrfqB4cRncQFMjhBiJ3zwMWSZS",
        "TTpD5TDduA6Acfj8eQfTnG8db9QSkzj9DA"
      ];
      const threshold = 2;

      // âœ… æ„é€  active æƒé™
      const active = {
        type: 2,
        permission_name: "active",
        threshold: threshold,
        operations: "7fff1fc0033e0100000000000000000000000000000000000000000000000000",
        keys: multisigAddrs.map(addr => ({
          address: tronWeb.address.toHex(addr).replace(/^0x/i, '').toLowerCase(),
          weight: 1
        }))
      };

      // âœ… æ„é€  owner æƒé™ï¼ˆå¿…é¡»æä¾›ï¼‰
      const owner = {
        permission_name: "owner",
        threshold: 2,
        keys: multisigAddrs.map(addr => ({
          address: tronWeb.address.toHex(addr).replace(/^0x/i, '').toLowerCase(),
          weight: 1
        }))
      };

      // âœ… å…³é”®ï¼šå­—æ®µåå¿…é¡»æ˜¯ owner å’Œ activesï¼ˆä¸æ˜¯ *_permissionï¼‰
      const contract = {
        owner_address: ownerHex,
        owner: owner,        // âœ… æ­£ç¡®å­—æ®µå
        actives: [active]    // âœ… æ­£ç¡®å­—æ®µå
      };

      log('ğŸ“¡ å‘é€ AccountPermissionUpdateContract...');
      console.log('Contract:', JSON.stringify(contract, null, 2));

      try {
        const tx = await tronWeb.fullNode.request('/wallet/accountpermissionupdate', contract, 'post');

        if (tx.Error) {
          return log('âŒ èŠ‚ç‚¹é”™è¯¯: ' + tx.Error);
        }

        log('âœï¸ è¯·æ±‚ TronLink ç­¾å...');
        const signed = await tronWeb.trx.sign(tx);

        log('ğŸ“¤ å¹¿æ’­äº¤æ˜“...');
        const result = await tronWeb.trx.sendRawTransaction(signed);

        if (result.result) {
          log('âœ… æˆåŠŸï¼TXID: ' + result.transaction.txID);
          log('ğŸ”— https://nile.tronscan.org/#/transaction/' + result.transaction.txID);
        } else {
          log('âŒ å¹¿æ’­å¤±è´¥: ' + JSON.stringify(result));
        }
      } catch (e) {
        log('ğŸ’¥ å¼‚å¸¸: ' + e.message);
        console.error(e);
      }
    }
  </script>
</body>
</html>
