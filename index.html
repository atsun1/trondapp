// ========== æ£€æŸ¥æ˜¯å¦åœ¨TronLink/æ³¢å®Proç¯å¢ƒï¼ˆä¿®å¤ç‰ˆæœ¬æ£€æµ‹ï¼‰ ==========
function checkTronLinkEnv() {
    if (!window.tronWeb) {
        log("âŒ æœªæ£€æµ‹åˆ°TronLink/æ³¢å®Proç¯å¢ƒï¼è¯·åœ¨é’±åŒ…å†…ç½®æµè§ˆå™¨æ‰“å¼€");
        alert("è¯·åœ¨TronLink/æ³¢å®Proå†…ç½®DAppæµè§ˆå™¨ä¸­è®¿é—®ï¼");
        return false;
    }
    // ä¿®å¤ï¼šä¸å†æ£€æµ‹requestæ–¹æ³•ï¼Œæ”¹ä¸ºæ£€æµ‹æ ¸å¿ƒçš„trxæ–¹æ³•ï¼ˆæ³¢å®Proæ”¯æŒï¼‰
    if (!window.tronWeb.trx || !window.tronWeb.trx.sendTransaction) {
        log("âš ï¸ æ£€æµ‹åˆ°éæ ‡å‡†TronLinkç¯å¢ƒï¼ˆæ³¢å®Proï¼‰ï¼Œå°è¯•å…¼å®¹æ¨¡å¼");
        alert("æ£€æµ‹åˆ°æ³¢å®Proç¯å¢ƒï¼Œå°†ä½¿ç”¨å…¼å®¹æ¨¡å¼è¿è¡Œï¼");
    }
    log("âœ… æ£€æµ‹åˆ°TronLink/æ³¢å®Proå†…ç½®æµè§ˆå™¨ç¯å¢ƒ");
    return true;
}

// ========== è¿æ¥é’±åŒ…ï¼ˆé€‚é…æ³¢å®Proï¼Œç§»é™¤requestæ–¹æ³•ä¾èµ–ï¼‰ ==========
async function connectWallet() {
    if (!checkTronLinkEnv()) return;

    try {
        tronWeb = window.tronWeb;
        
        // ä¿®å¤ï¼šæ³¢å®Proæ— éœ€è°ƒç”¨tron_requestAccountsï¼Œç›´æ¥è·å–åœ°å€ï¼ˆè‡ªåŠ¨æˆæƒï¼‰
        let address = null;
        try {
            // å…ˆå°è¯•æ–°ç‰ˆAPI
            const accounts = await tronWeb.request({ 
                method: 'tron_requestAccounts',
                params: [] 
            });
            address = accounts[0];
        } catch (e) {
            // æ³¢å®Proå…¼å®¹ï¼šç›´æ¥è·å–é»˜è®¤åœ°å€ï¼ˆæ— éœ€æ˜¾å¼æˆæƒï¼‰
            log("ğŸ”„ æ³¢å®Proå…¼å®¹æ¨¡å¼ï¼šç›´æ¥è·å–é’±åŒ…åœ°å€");
            address = tronWeb.defaultAddress.base58;
            if (!address) address = tronWeb.defaultAddress.hex;
        }

        if (!address) {
            log("âŒ æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œè¯·ç¡®è®¤é’±åŒ…å·²ç™»å½•");
            alert("æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œè¯·ç™»å½•æ³¢å®Proï¼");
            return;
        }

        // æ ¡éªŒNileæµ‹è¯•ç½‘
        const chainId = String(await tronWeb.trx.getChainId());
        if (chainId !== NILE_CHAIN_ID) {
            log(`âŒ å½“å‰ç½‘ç»œä¸æ˜¯Nileæµ‹è¯•ç½‘ï¼å½“å‰é“¾IDï¼š${chainId}ï¼Œéœ€è¦ï¼š${NILE_CHAIN_ID}`);
            alert("è¯·å°†æ³¢å®Proåˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘ï¼");
            return;
        }

        // æ ¼å¼åŒ–åœ°å€
        address = tronWeb.address.fromHex(address);
        log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼åœ°å€ï¼š${address}`);
        log(`âœ… å½“å‰ç½‘ç»œï¼šNileæµ‹è¯•ç½‘ï¼ˆé“¾IDï¼š${chainId}ï¼‰`);
        document.getElementById("transferBtn").style.display = "block";

    } catch (e) {
        log(`âŒ è¿æ¥é’±åŒ…å¤±è´¥ï¼š${e.message}`);
        alert(`è¿æ¥å¤±è´¥ï¼š${e.message}`);
    }
}
