<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USDT æˆæƒç¤ºä¾‹ - TronLink DApp</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h2 {
      text-align: center;
      color: #007AFF;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #connectBtn {
      background: #007AFF;
      color: white;
    }
    #approveBtn {
      background: #34C759;
      color: white;
      opacity: 0.7;
    }
    #approveBtn:enabled {
      opacity: 1;
    }
    #approveBtn:hover:enabled {
      opacity: 0.9;
    }
    .info {
      padding: 12px;
      margin: 12px 0;
      background: #eef8ff;
      border-left: 4px solid #007AFF;
      border-radius: 4px;
      font-size: 14px;
    }
    .error {
      padding: 12px;
      background: #ffeaea;
      border-left: 4px solid #ff3b30;
      color: #d32f2f;
      border-radius: 4px;
    }
    .success {
      padding: 12px;
      background: #e8f5e9;
      border-left: 4px solid #34C759;
      color: #2e7d32;
      border-radius: 4px;
    }
    .label {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸ” USDT æˆæƒ</h2>
    <p>æˆæƒ 1000 USDT ç»™æŒ‡å®šåˆçº¦åœ°å€ï¼ˆTRC20ï¼‰</p>

    <button id="connectBtn">ğŸ”Œ è¿æ¥ TronLink</button>
    <div id="accountInfo"></div>
    <div id="status"></div>

    <button id="approveBtn" disabled>âœ… æˆæƒ 1000 USDT</button>

    <div class="label">
      âš ï¸ æ³¨æ„ï¼šæ­¤æ“ä½œå°†å…è®¸ç›®æ ‡åœ°å€ä»æ‚¨çš„è´¦æˆ·è½¬ç§»æœ€å¤š 1000 USDTã€‚
    </div>
  </div>

  <script>
    // ========================
    // é…ç½®ï¼ˆè¯·æŒ‰éœ€ä¿®æ”¹ï¼‰
    // ========================
    const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // TRON ä¸»ç½‘ USDT
    const SPENDER_ADDRESS = "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3"; // â† æ›¿æ¢ä¸ºä½ çš„ DApp åˆçº¦åœ°å€
    const AMOUNT_USDT = 1000; // æˆæƒæ•°é‡
    const DECIMALS = 6;       // USDT ç²¾åº¦

    // ========================
    // å·¥å…·å‡½æ•°ï¼šå°† 1000 è½¬ä¸º 1000000000ï¼ˆå¸¦ç²¾åº¦ï¼‰
    // ========================
    function toTokenAmount(value, decimals) {
      return (value * Math.pow(10, decimals)).toString();
    }

    // ========================
    // æ˜¾ç¤ºæ¶ˆæ¯
    // ========================
    function showMessage(el, text, type = 'info') {
      el.className = type;
      el.textContent = text;
    }

    // ========================
    // è¿æ¥é’±åŒ…
    // ========================
    document.getElementById('connectBtn').addEventListener('click', async () => {
      const accountEl = document.getElementById('accountInfo');
      const statusEl = document.getElementById('status');

      if (!window.tronWeb) {
        showMessage(statusEl, 'âŒ æœªæ£€æµ‹åˆ° TronLinkï¼Œè¯·åœ¨ TronLink App ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
        return;
      }

      try {
        // è¯·æ±‚ç”¨æˆ·è´¦æˆ·ï¼ˆå®˜æ–¹æ¨èæ–¹å¼ï¼‰
        const accounts = await window.tronWeb.request({ method: 'tron_requestAccounts' });
        const address = accounts[0];

        accountEl.innerHTML = `<strong>è´¦æˆ·ï¼š</strong>${address}`;
        showMessage(statusEl, 'âœ… å·²è¿æ¥ TronLink', 'success');
        document.getElementById('approveBtn').disabled = false;
      } catch (err) {
        console.error('è¿æ¥å¤±è´¥', err);
        showMessage(statusEl, 'âŒ ç”¨æˆ·æ‹’ç»äº†è´¦æˆ·è®¿é—®æƒé™', 'error');
      }
    });

    // ========================
    // æˆæƒæ“ä½œ
    // ========================
    document.getElementById('approveBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('status');
      const amount = toTokenAmount(AMOUNT_USDT, DECIMALS);

      try {
        showMessage(statusEl, 'â³ æ­£åœ¨å‘èµ·æˆæƒäº¤æ˜“...', 'info');

        // è·å–åˆçº¦å®ä¾‹
        const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
        
        // è°ƒç”¨ approve
        const tx = await contract.approve(SPENDER_ADDRESS, amount).send({
          feeLimit: 100_000_000 // 100 TRX ä¸Šé™ï¼ˆè¶³å¤Ÿè¦†ç›–ï¼‰
        });

        showMessage(statusEl, `âœ… æˆæƒæˆåŠŸï¼\näº¤æ˜“ ID: ${tx.transaction}`, 'success');
      } catch (err) {
        console.error('æˆæƒå¤±è´¥', err);
        let msg = err.message || String(err);
        if (msg.includes('user denied') || msg.includes('User denied')) {
          msg = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
        }
        showMessage(statusEl, `âŒ æˆæƒå¤±è´¥ï¼š${msg}`, 'error');
      }
    });
  </script>
</body>
</html>
