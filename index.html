<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<body>
    <button onclick="triggerTronLinkTransfer()">唤起TronLink转账（Nile测试网）</button>
    <div id="tip" style="margin-top:20px;color:red;"></div>
    <div id="callbackResult" style="margin-top:10px;color:green;"></div>

    <script>
        // ========== 1. 配置转账核心参数（已适配Nile测试网） ==========
        const transferConfig = {
            // 基础协议参数（固定规范）
            protocol: "TronLink",
            version: "1.0",
            chainId: "0xa869", // 关键修改：Nile测试网chainId（主网是0x2b6653dc）
            action: "transfer",    // 操作类型：转账（固定值）
            actionId: generateUUID(), // 唯一标识（需自定义生成）
            
            // 转账业务参数（替换为测试网地址）
            memo: "Test Transfer (Nile Testnet)",  // 转账备注（标注测试网）
            from: "TDx8EWSQKrfqB4cRncQFMjhBiJ3zwMWSZS", // 测试网付款地址（需确保是Nile测试网地址）
            to: "TJceZJwWdyqnCh5BTXABDBJM2PRh6SMB3E",    // 测试网收款地址
            loginAddress: "TDx8EWSQKrfqB4cRncQFMjhBiJ3zwMWSZS", // 关键修改：登录地址需和from一致（测试网）
            tokenId: "0",           // 0=测试网TRX，代币转账填测试网tokenId
            contract: "",           // 测试网TRX转账留空，代币填测试网合约地址
            amount: "20",           // 转账数量（测试网TRX，无实际价值）
            
            // DApp相关参数（可保留或替换为测试网DApp地址）
            url: "https://justlend.org/#/home", // 测试网DApp主页（可选替换）
            dappIcon: "https://test/icon.png",  // DApp图标（可选）
            dappName: "Test demo (Nile Testnet)",// 标注测试网
            callbackUrl: "http://3.12.131.175:7777/api/tron/v1/callback" // 测试网回调地址（需后端适配）
        };

        // ========== 2. 工具函数：生成唯一actionId（UUID） ==========
        function generateUUID() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        // ========== 3. 核心：构造转账唤起链接并触发 ==========
        function triggerTronLinkTransfer() {
            try {
                // 步骤1：将转账参数转为JSON字符串
                const paramJson = JSON.stringify(transferConfig);
                // 步骤2：URL编码（官方强制要求）
                const encodedParam = encodeURIComponent(paramJson);
                // 步骤3：拼接TronLink v4.11.0唤起链接
                const wakeUpUrl = `tronlinkoutside://pull.activity?param=${encodedParam}`;

                // 步骤4：触发唤起（打开TronLink并调起转账弹窗）
                const a = document.createElement('a');
                a.href = wakeUpUrl;
                a.click();

                // 步骤5：唤起失败兜底提示（标注测试网）
                setTimeout(() => {
                    document.getElementById("tip").innerText = `唤起失败？请手动操作（Nile测试网）：
1. 打开TronLink v4.11.0+ APP → 切换到Nile测试网
2. 切换到地址 ${transferConfig.from}
3. 手动转账至 ${transferConfig.to}，数量：${transferConfig.amount} 测试网TRX`;
                }, 2000);

                // 步骤6：监听回调（需后端配合）
                listenTransferCallback(transferConfig.actionId);

            } catch (e) {
                document.getElementById("tip").innerText = `唤起异常：${e.message}`;
            }
        }

        // ========== 4. 可选：监听转账回调结果（需后端配合） ==========
        function listenTransferCallback(actionId) {
            // 轮询后端callbackUrl，查询测试网转账结果
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`http://3.12.131.175:7777/api/tron/v1/query?actionId=${actionId}`);
                    const result = await response.json();
                    
                    if (result.code === 0 && result.transactionHash) {
                        clearInterval(pollInterval);
                        document.getElementById("callbackResult").innerText = `✅ 测试网转账成功！
交易哈希：${result.transactionHash}
ActionId：${actionId}
（可在Nile测试网浏览器查询该哈希）`;
                    } else if (result.code !== 0) {
                        clearInterval(pollInterval);
                        document.getElementById("tip").innerText = `❌ 测试网转账失败：${result.message}`;
                    }
                } catch (e) {
                    console.log("测试网查询回调中...", e);
                }
            }, 3000); // 每3秒查询一次
        }
    </script>
</body>
</html>
