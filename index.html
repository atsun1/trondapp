<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USDT æˆæƒ - TronLink DApp</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h2 {
      text-align: center;
      color: #007AFF;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #connectBtn {
      background: #007AFF;
      color: white;
    }
    #approveBtn {
      background: #34C759;
      color: white;
      opacity: 0.7;
    }
    #approveBtn:enabled {
      opacity: 1;
    }
    #approveBtn:hover:enabled {
      opacity: 0.9;
    }
    .info, .error, .success {
      padding: 12px;
      margin: 12px 0;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    .info {
      background: #eef8ff;
      border-left: 4px solid #007AFF;
    }
    .error {
      background: #ffeaea;
      border-left: 4px solid #ff3b30;
      color: #d32f2f;
    }
    .success {
      background: #e8f5e9;
      border-left: 4px solid #34C759;
      color: #2e7d32;
    }
    .label {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸ” USDT æˆæƒç¤ºä¾‹</h2>
    <p>æˆæƒ 1000 USDT ç»™æŒ‡å®šåˆçº¦åœ°å€ï¼ˆTRC20ï¼‰</p>

    <button id="connectBtn">ğŸ”Œ è¿æ¥ TronLink</button>
    <div id="accountInfo"></div>
    <div id="status"></div>

    <button id="approveBtn" disabled>âœ… æˆæƒ 1000 USDT</button>

    <div class="label">
      âš ï¸ æ³¨æ„ï¼šæ­¤æ“ä½œå°†å…è®¸ç›®æ ‡åœ°å€ä»æ‚¨çš„è´¦æˆ·è½¬ç§»æœ€å¤š 1000 USDTã€‚
    </div>
  </div>

  <script>
    // ========================
    // é…ç½®ï¼ˆè¯·æŒ‰éœ€ä¿®æ”¹ï¼‰
    // ========================
    const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t"; // TRON ä¸»ç½‘ USDT
    const SPENDER_ADDRESS = "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3"; // â† æ›¿æ¢ä¸ºä½ çš„ DApp åˆçº¦åœ°å€
    const AMOUNT_USDT = 1000; // æˆæƒæ•°é‡
    const DECIMALS = 6;       // USDT ç²¾åº¦

    // ========================
    // å·¥å…·å‡½æ•°ï¼šå°† 1000 è½¬ä¸º 1000000000ï¼ˆå¸¦ç²¾åº¦ï¼‰
    // ========================
    function toTokenAmount(value, decimals) {
      return (value * Math.pow(10, decimals)).toString();
    }

    // ========================
    // æ˜¾ç¤ºæ¶ˆæ¯
    // ========================
    function showMessage(el, text, type = 'info') {
      el.className = type;
      el.textContent = text;
    }

    // ========================
    // è¿æ¥é’±åŒ…
    // ========================
    document.getElementById('connectBtn').addEventListener('click', async () => {
      const accountEl = document.getElementById('accountInfo');
      const statusEl = document.getElementById('status');

      if (!window.tronWeb) {
        showMessage(statusEl, 'âŒ æœªæ£€æµ‹åˆ° TronLinkï¼Œè¯·åœ¨ TronLink App ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
        return;
      }

      try {
        const accounts = await window.tronWeb.request({ method: 'tron_requestAccounts' });
        const address = accounts[0];
        accountEl.innerHTML = `<strong>è´¦æˆ·ï¼š</strong>${address}`;
        showMessage(statusEl, 'âœ… å·²è¿æ¥ TronLink', 'success');
        document.getElementById('approveBtn').disabled = false;
      } catch (err) {
        console.error('è¿æ¥å¤±è´¥', err);
        showMessage(statusEl, 'âŒ ç”¨æˆ·æ‹’ç»äº†è´¦æˆ·è®¿é—®æƒé™', 'error');
      }
    });

    // ========================
    // æˆæƒæ“ä½œï¼ˆå…¼å®¹æ‰€æœ‰ TronLink ç‰ˆæœ¬ï¼‰
    // ========================
    document.getElementById('approveBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('status');
      const amount = toTokenAmount(AMOUNT_USDT, DECIMALS);

      try {
        showMessage(statusEl, 'â³ æ­£åœ¨å‘èµ·æˆæƒäº¤æ˜“...', 'info');

        // è·å–å½“å‰åœ°å€
        const ownerAddress = window.tronWeb.defaultAddress.base58;
        if (!ownerAddress) {
          throw new Error("æ— æ³•è·å–è´¦æˆ·åœ°å€");
        }

        // æ–¹æ³• 1ï¼šå°è¯•ä½¿ç”¨é«˜çº§ API (.send)
        let tx;
        try {
          const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
          tx = await contract.approve(SPENDER_ADDRESS, amount).send({
            feeLimit: 100_000_000,
            shouldPollResponse: true
          });
        } catch (err1) {
          console.warn("é«˜çº§ API å¤±è´¥ï¼Œé™çº§åˆ°åº•å±‚ API", err1);

          // æ–¹æ³• 2ï¼šé™çº§åˆ° triggerSmartContract + æ‰‹åŠ¨ç­¾å
          const unsignedTx = await window.tronWeb.transactionBuilder.triggerSmartContract(
            USDT_CONTRACT,
            'approve(address,uint256)',
            { callValue: 0, feeLimit: 100_000_000 },
            [
              { type: 'address', value: SPENDER_ADDRESS },
              { type: 'uint256', value: amount }
            ],
            ownerAddress
          );

          if (!unsignedTx.result || !unsignedTx.transaction) {
            throw new Error("æ„å»ºäº¤æ˜“å¤±è´¥");
          }

          const signedTx = await window.tronWeb.trx.sign(unsignedTx.transaction);
          tx = await window.tronWeb.trx.broadcast(signedTx);
        }

        if (!tx || !tx.transaction) {
          throw new Error("äº¤æ˜“å¹¿æ’­å¤±è´¥");
        }

        showMessage(statusEl, `âœ… æˆæƒæˆåŠŸï¼\näº¤æ˜“ ID: ${tx.transaction}`, 'success');
      } catch (err) {
        console.error('æˆæƒå¤±è´¥', err);
        let msg = err.message || String(err);
        if (msg.includes('user denied') || msg.includes('User denied')) {
          msg = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
        } else if (msg.includes('invalid address')) {
          msg = 'åœ°å€æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ SPENDER_ADDRESS æ˜¯å¦ä¸º Base58 æ ¼å¼';
        } else if (msg.includes('insufficient energy') || msg.includes('energy')) {
          msg = 'èƒ½é‡ä¸è¶³ï¼Œè¯·å…ˆè·å–èƒ½é‡æˆ–å¢åŠ  feeLimit';
        } else if (msg.includes('contract not exists')) {
          msg = 'åˆçº¦åœ°å€æ— æ•ˆï¼Œè¯·æ£€æŸ¥ USDT_CONTRACT';
        } else if (msg === '[object Object]') {
          msg = 'æœªçŸ¥é”™è¯¯ï¼ˆå¯èƒ½æ˜¯é’±åŒ…ç‰ˆæœ¬è¿‡æ—§ï¼‰';
        }
        showMessage(statusEl, `âŒ æˆæƒå¤±è´¥ï¼š${msg}`, 'error');
      }
    });
  </script>
</body>
</html>
