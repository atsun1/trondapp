<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¬è´¦1 TRXï¼ˆæ³¢å®Pro/Nileæµ‹è¯•ç½‘å…¼å®¹ç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .container { max-width: 500px; margin: 30px auto; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .btn {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            color: white;
        }
        .call-btn { background: #6c757d; cursor: not-allowed; }
        .transfer-btn { background: #28a745; display: none; }
        .manual-btn { background: #007bff; }
        .tip {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .info-tip { background: #d1ecf1; color: #0c5460; }
        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            min-height: 200px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>è½¬è´¦1 TRXåˆ°æŒ‡å®šåœ°å€ï¼ˆNileæµ‹è¯•ç½‘ï¼‰</h2>
        
        <div class="info-tip">
            ğŸ¯ ç›®æ ‡åœ°å€ï¼š<br>
            <code>TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3</code>
        </div>

        <!-- ç¦ç”¨å”¤èµ·æŒ‰é’®ï¼ˆæ¨¡æ‹Ÿå™¨ä¸æ”¯æŒï¼‰ -->
        <button class="btn call-btn">å”¤èµ·TronLinké’±åŒ…ï¼ˆé›·ç”µæ¨¡æ‹Ÿå™¨ä¸æ”¯æŒï¼‰</button>
        <!-- è½¬è´¦æŒ‰é’®ï¼ˆè¿æ¥é’±åŒ…åæ˜¾ç¤ºï¼‰ -->
        <button class="btn transfer-btn" id="transferBtn" onclick="transfer1TRX()">å‘èµ·1 TRXè½¬è´¦</button>

        <!-- è°ƒè¯•æ—¥å¿—åŒº -->
        <div id="log">[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼Œé€‚é…æ³¢å®Proç¯å¢ƒ...</div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const LOCAL_IP = "192.168.1.100"; // æ›¿æ¢ä¸ºä½ çš„å±€åŸŸç½‘IP
        const LOCAL_PORT = 8080;
        const DAPP_URL = `http://${LOCAL_IP}:${LOCAL_PORT}/tron-transfer-1trx.html`;
        const TARGET_ADDRESS = "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3";
        const TRANSFER_AMOUNT = 1;
        const NILE_CHAIN_ID = "4";

        let tronWeb = null;

        // ========== å·¥å…·å‡½æ•° ==========
        function log(msg) {
            const logEl = document.getElementById("log");
            const time = new Date().toLocaleTimeString();
            const logMsg = `[${time}] ${msg}`;
            logEl.innerHTML += logMsg + "\n";
            logEl.scrollTop = logEl.scrollHeight;
            console.log(logMsg);
            if (msg.includes("âŒ") || msg.includes("Error")) {
                alert(`ã€æŠ¥é”™ã€‘${msg}`);
            }
        }

        // ========== ä¿®å¤ï¼šå…¼å®¹æ³¢å®Proçš„ç¯å¢ƒæ£€æµ‹ ==========
        function checkTronLinkEnv() {
            if (!window.tronWeb) {
                log("âŒ æœªæ£€æµ‹åˆ°TronLink/æ³¢å®Proç¯å¢ƒï¼");
                alert("è¯·åœ¨æ³¢å®Proå†…ç½®DAppæµè§ˆå™¨ä¸­æ‰“å¼€ï¼");
                return false;
            }
            // ä¸æ£€æµ‹requestæ–¹æ³•ï¼Œåªæ£€æµ‹æ ¸å¿ƒè½¬è´¦API
            if (!window.tronWeb.trx || !window.tronWeb.trx.sendTransaction) {
                log("âš ï¸ æ³¢å®Proå…¼å®¹æ¨¡å¼å¯åŠ¨");
                alert("æ³¢å®Proå…¼å®¹æ¨¡å¼ï¼Œå¯æ­£å¸¸è½¬è´¦ï¼");
            }
            log("âœ… æ£€æµ‹åˆ°æ³¢å®Proç¯å¢ƒ");
            return true;
        }

        // ========== ä¿®å¤ï¼šå…¼å®¹æ³¢å®Proçš„é’±åŒ…è¿æ¥ ==========
        async function connectWallet() {
            if (!checkTronLinkEnv()) return;

            try {
                tronWeb = window.tronWeb;
                
                // å…¼å®¹æ³¢å®Proï¼šä¼˜å…ˆå°è¯•æ–°ç‰ˆAPIï¼Œå¤±è´¥åˆ™ç›´æ¥è·å–åœ°å€
                let address = null;
                try {
                    const accounts = await tronWeb.request({ 
                        method: 'tron_requestAccounts',
                        params: [] 
                    });
                    address = accounts[0];
                } catch (e) {
                    log(`ğŸ”„ å…¼å®¹æ¨¡å¼ï¼š${e.message}ï¼Œç›´æ¥è·å–åœ°å€`);
                    address = tronWeb.defaultAddress.base58 || tronWeb.defaultAddress.hex;
                }

                if (!address) {
                    log("âŒ æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œè¯·ç™»å½•æ³¢å®Pro");
                    alert("è¯·å…ˆç™»å½•æ³¢å®Proé’±åŒ…ï¼");
                    return;
                }

                // æ ¡éªŒNileæµ‹è¯•ç½‘
                const chainId = String(await tronWeb.trx.getChainId());
                if (chainId !== NILE_CHAIN_ID) {
                    log(`âŒ å½“å‰ç½‘ç»œä¸æ˜¯Nileæµ‹è¯•ç½‘ï¼ˆé“¾IDï¼š${chainId}ï¼‰`);
                    alert("è¯·åˆ‡æ¢åˆ°Nileæµ‹è¯•ç½‘ï¼");
                    return;
                }

                address = tronWeb.address.fromHex(address);
                log(`âœ… è¿æ¥æˆåŠŸï¼åœ°å€ï¼š${address}`);
                document.getElementById("transferBtn").style.display = "block";

            } catch (e) {
                log(`âŒ è¿æ¥å¤±è´¥ï¼š${e.message}`);
                alert(`è¿æ¥å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ========== è½¬è´¦1 TRXï¼ˆå…¼å®¹æ³¢å®Proï¼‰ ==========
        async function transfer1TRX() {
            if (!tronWeb) {
                log("âŒ é’±åŒ…æœªå°±ç»ª");
                alert("é’±åŒ…æœªè¿æ¥ï¼");
                return;
            }

            try {
                const amountInSun = tronWeb.toSun(TRANSFER_AMOUNT);
                log(`ğŸ“¤ è½¬è´¦1 TRXåˆ° ${TARGET_ADDRESS}`);
                log("ğŸ”„ ç­‰å¾…æ³¢å®Proç¡®è®¤ä»˜æ¬¾...");

                // æ³¢å®Proå…¼å®¹çš„è½¬è´¦è°ƒç”¨
                const transaction = await tronWeb.trx.sendTransaction(
                    TARGET_ADDRESS,
                    amountInSun
                );

                log(`âœ… è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}`);
                log(`ğŸ” æŸ¥çœ‹ï¼šhttps://nile.tronscan.org/#/transaction/${transaction.txid}`);
                alert(`è½¬è´¦æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œï¼š${transaction.txid}`);

            } catch (e) {
                log(`âŒ è½¬è´¦å¤±è´¥ï¼š${e.message}`);
                alert(`è½¬è´¦å¤±è´¥ï¼š${e.message}`);
            }
        }

        // ========== é¡µé¢åˆå§‹åŒ–ï¼ˆè‡ªåŠ¨è¿æ¥ï¼‰ ==========
        window.onload = function() {
            log(`ğŸ“± DAppåœ°å€ï¼š${DAPP_URL}`);
            // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿æ¥é’±åŒ…ï¼ˆæ³¢å®Proæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ï¼‰
            setTimeout(connectWallet, 500);
        };
    </script>
</body>
</html>
